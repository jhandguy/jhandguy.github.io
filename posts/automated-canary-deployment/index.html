<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Canary Deployment in Kubernetes (Part 2) ‚Äî Automated Canary Deployment using Argo Rollouts</title>
    <link rel="stylesheet" href="/css/bulma.min.css">
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="stylesheet" href="/css/hugo.css">
</head>

<body>
<nav class="navbar">
    <div class="navbar-brand">
        <a class="navbar-item" href="/">
            Home
        </a>

        <div class="navbar-item">
            <a class="button is-link" href="/about">
                <strong>About me</strong>
            </a>
        </div>
    </div>
</nav>

<section class="section">
    <div class="container is-max-desktop">
        <div class="content">
            <p class="title is-spaced">Canary Deployment in Kubernetes (Part 2) ‚Äî Automated Canary Deployment using Argo Rollouts</p>
            
            
            <div class="box">
                <p class="subtitle">Table of Contents</p>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#creating-kind-cluster">Creating Kind Cluster</a></li>
    <li><a href="#using-argo-rollouts-with-nginx-ingress-controller">Using Argo Rollouts with NGINX Ingress Controller</a>
      <ul>
        <li><a href="#installing-nginx-ingress-controller">Installing NGINX Ingress Controller</a></li>
        <li><a href="#installing-argo-rollouts">Installing Argo Rollouts</a></li>
      </ul>
    </li>
    <li><a href="#configuring-rollout-resources">Configuring Rollout Resources</a></li>
    <li><a href="#automating-incremental-rollouts">Automating Incremental Rollouts</a>
      <ul>
        <li><a href="#load-testing-with-k6">Load Testing with k6</a></li>
        <li><a href="#promoting-rollouts">Promoting Rollouts</a></li>
      </ul>
    </li>
    <li><a href="#wrapping-up">Wrapping up</a></li>
  </ul>
</nav>
            </div>
            
            
        </div>
    </div>
    <div class="container is-max-desktop mt-6">
        <div class="content has-text-justified-tablet">
            <p>Deploying to production in Kubernetes can be quite stressful. Even after meaningful and reliable automated tests have successfully passed, there is still room for things to go wrong and lead to a nasty incident when pressing the final button.</p>
<p>Thankfully, Kubernetes is made to be resilient to this kind of scenario, and rolling back is a no-brainer. But still, rolling back means that, at least for some time, <strong>all of the users</strong> were negatively impacted by the faulty change‚Ä¶</p>
<p>What if we could smoke test our change in production <strong>before</strong> it actually hits real users? What if we could roll out a change incrementally to <strong>some users</strong> instead of all of them at once? What if we could detect a faulty deployment and roll it back automatically?<br>
Well, that, my friend, is what Canary Deployment is all about!</p>
<blockquote>
<p>Minimizing the impact on real users while deploying a risky change to production.</p>
</blockquote>
<p>üé¨ Hi there, I‚Äôm Jean!</p>
<p>In this 3 parts series, we‚Äôre going to explore several ways to do Canary Deployment in Kubernetes, and the first one is‚Ä¶<br>
ü•Å<br>
‚Ä¶ using <strong>Argo Rollouts</strong>! üéä</p>
<h2 id="requirements">Requirements</h2>
<hr>
<p>Before we start, make sure you have the following tools installed:</p>
<ul>
<li><a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation">Kind</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/">Kubectl</a></li>
<li><a href="https://argoproj.github.io/argo-rollouts/installation/#kubectl-plugin-installation">Argo Rollouts Kubectl Plugin</a></li>
<li><a href="https://helm.sh/docs/intro/install/">Helm</a></li>
<li><a href="https://k6.io/docs/getting-started/installation/">K6</a></li>
</ul>
<blockquote>
<p><em>Note: for MacOS users or Linux users using Homebrew, simply run:</em><br>
<code>brew install kind kubectl argoproj/tap/kubectl-argo-rollouts helm k6</code></p>
</blockquote>
<p>All set? Let‚Äôs go! üèÅ</p>
<h2 id="creating-kind-cluster">Creating Kind Cluster</h2>
<hr>
<p><a href="https://kind.sigs.k8s.io/">Kind</a> is a tool for running local Kubernetes clusters using Docker container ‚Äúnodes‚Äù.
It was primarily designed for testing Kubernetes itself, but may be used for local development or CI.</p>
<p>I don‚Äôt expect you to have a demo project in handy, so <a href="https://github.com/jhandguy/canary-deployment">I built one</a> for you.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git clone https://github.com/jhandguy/canary-deployment.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> canary-deployment
</span></span></code></pre></div><p>Alright, let&rsquo;s spin up our Kind cluster! üöÄ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kind create cluster --image kindest/node:v1.27.3 --config<span class="o">=</span>kind/cluster.yaml
</span></span><span class="line"><span class="cl">Creating cluster <span class="s2">&#34;kind&#34;</span> ...
</span></span><span class="line"><span class="cl"> ‚úì Ensuring node image <span class="o">(</span>kindest/node:v1.27.3<span class="o">)</span> üñº
</span></span><span class="line"><span class="cl"> ‚úì Preparing nodes üì¶
</span></span><span class="line"><span class="cl"> ‚úì Writing configuration üìú
</span></span><span class="line"><span class="cl"> ‚úì Starting control-plane üïπÔ∏è
</span></span><span class="line"><span class="cl"> ‚úì Installing CNI üîå
</span></span><span class="line"><span class="cl"> ‚úì Installing StorageClass üíæ
</span></span><span class="line"><span class="cl">Set kubectl context to <span class="s2">&#34;kind-kind&#34;</span>
</span></span><span class="line"><span class="cl">You can now use your cluster with:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl cluster-info --context kind-kind
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community üôÇ
</span></span></code></pre></div><h2 id="using-argo-rollouts-with-nginx-ingress-controller">Using Argo Rollouts with NGINX Ingress Controller</h2>
<hr>
<p><a href="https://argoproj.github.io/argo-rollouts/">Argo Rollouts</a> is a <a href="https://kubernetes.io/docs/concepts/architecture/controller/">Kubernetes controller</a> and set of <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">CRDs</a> which provide advanced deployment capabilities to Kubernetes such as blue-green, canary, canary analysis, experimentation, and progressive delivery.</p>
<p>In combination with the <a href="https://argoproj.github.io/argo-rollouts/features/traffic-management/nginx/">NGINX Ingress Controller</a>, Argo Rollouts achieves the same as a <a href="/posts/simple-canary-deployment/">Simple Canary Deployment using Ingress NGINX</a>, but better.</p>
<h3 id="installing-nginx-ingress-controller">Installing NGINX Ingress Controller</h3>
<hr>
<blockquote>
<p><em>If you haven‚Äôt already, go read <a href="/posts/simple-canary-deployment/">Canary Deployment in Kubernetes (Part 1) ‚Äî Simple Canary Deployment using Ingress NGINX</a> and learn how to implement a Simple Canary Deployment using Ingress NGINX!</em></p>
</blockquote>
<p><a href="https://github.com/kubernetes/ingress-nginx">NGINX Ingress Controller</a> is one of the <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/#additional-controllers">many available Kubernetes Ingress Controllers</a>, which acts as a load balancer and satisfies routing rules specified in <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#what-is-ingress">Ingress</a> resources, using the <a href="https://nginx.org/en/">NGINX reverse proxy</a>.</p>
<p>NGINX Ingress Controller can be installed via its <a href="https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx">Helm chart</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
</span></span><span class="line"><span class="cl">helm install ingress-nginx/ingress-nginx --name-template ingress-nginx --create-namespace -n ingress-nginx --values kind/ingress-nginx-values.yaml --version 4.8.3 --wait
</span></span></code></pre></div><p>Now, if everything goes according to plan, you should be able to see the <strong>ingress-nginx-controller</strong> Deployment running.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl get deploy -n ingress-nginx
</span></span><span class="line"><span class="cl">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">ingress-nginx-controller   1/1     <span class="m">1</span>            <span class="m">1</span>           4m35s
</span></span></code></pre></div><h3 id="installing-argo-rollouts">Installing Argo Rollouts</h3>
<hr>
<p>Argo Rollouts can be installed via its <a href="https://github.com/argoproj/argo-helm/tree/master/charts/argo-rollouts">Helm chart</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm repo add argo https://argoproj.github.io/argo-helm
</span></span><span class="line"><span class="cl">helm install argo/argo-rollouts --name-template argo-rollouts --create-namespace -n argo-rollouts --set dashboard.enabled<span class="o">=</span><span class="nb">true</span> --version 2.32.5 --wait
</span></span></code></pre></div><p>If all goes well, you should see two newly spawned Deployments with the READY state.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl get deploy -n argo-rollouts
</span></span><span class="line"><span class="cl">NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">argo-rollouts             1/1     <span class="m">1</span>            <span class="m">1</span>           13m
</span></span><span class="line"><span class="cl">argo-rollouts-dashboard   1/1     <span class="m">1</span>            <span class="m">1</span>           13m
</span></span></code></pre></div><h2 id="configuring-rollout-resources">Configuring Rollout Resources</h2>
<hr>
<p>One of the limitations of using Ingress NGINX alone is that it requires the duplication of quite a few Kubernetes resources. If you remember in <a href="/posts/simple-canary-deployment/">Part 1</a>, the <strong>Deployment</strong>, <strong>Service</strong>, and <strong>Ingress</strong> resources were almost identically cloned.<br>
With Argo Rollouts, the duplication of Kubernetes resources is reduced to only one: the <strong>Service</strong> resource.</p>
<p>Another limitation of using plain Ingress NGINX is that the incremental rollout of the Canary Deployment (via <code>canary-weight</code>) has to be done manually by annotating the canary Ingress.<br>
Argo Rollouts created its own <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">Custom Resource</a> to remediate that problem: the <strong><a href="https://argoproj.github.io/argo-rollouts/features/specification/">Rollout</a></strong> resource.</p>
<p>Alrighty then! Let‚Äôs get to it! üßê</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm install sample-app/helm-charts/argo-rollouts --name-template sample-app --create-namespace -n sample-app --wait
</span></span></code></pre></div><p>If everything goes fine, you should eventually see one Rollout with the READY state.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl get rollout sample-app -n sample-app
</span></span><span class="line"><span class="cl">NAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE
</span></span><span class="line"><span class="cl">sample-app   <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>            <span class="m">1</span>
</span></span></code></pre></div><p>Alright, let‚Äôs take a look at what‚Äôs under all this!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú ls -1 sample-app/helm-charts/argo-rollouts/templates
</span></span><span class="line"><span class="cl">analysistemplate.yaml
</span></span><span class="line"><span class="cl">canary
</span></span><span class="line"><span class="cl">ingress.yaml
</span></span><span class="line"><span class="cl">rollout.yaml
</span></span><span class="line"><span class="cl">service.yaml
</span></span><span class="line"><span class="cl">serviceaccount.yaml
</span></span><span class="line"><span class="cl">servicemonitor.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">‚ûú ls -1 sample-app/helm-charts/argo-rollouts/templates/canary
</span></span><span class="line"><span class="cl">service.yaml
</span></span></code></pre></div><blockquote>
<p><em>Note: ignore the <code>analysistemplate.yaml</code> and the <code>servicemonitor.yaml</code> for now and focus on the rest of the resources.</em></p>
</blockquote>
<p>As you can see, there is only one resource that has been duplicated in the <code>canary</code> folder: the <code>service.yaml</code>.</p>
<p>Now you might wonder, where did the <strong>Deployment</strong> resource go?! ü§î</p>
<p>In Argo Rollouts, the <strong>Deployment</strong> resource has been replaced with the <strong><a href="https://argoproj.github.io/argo-rollouts/features/specification/">Rollout</a></strong> resource. It is pretty much the same though, except it contains some extra specifications.</p>
<p>In fact, if you compare the <code>deployment.yaml</code> from <a href="/posts/simple-canary-deployment/">Part 1</a> with the <code>rollout.yaml</code>, you will find that they are very similar, except for the <code>strategy</code> spec which is very unique to the <strong>Rollout</strong> resource.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rollout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">canary</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">canaryService</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-canary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">stableService</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">canaryMetadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">canary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">stableMetadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">stable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">trafficRouting</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nginx</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">stableIngress</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">additionalIngressAnnotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">canary-by-header</span><span class="p">:</span><span class="w"> </span><span class="l">X-Canary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">75</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span></code></pre></div><p>Now, let‚Äôs break down what is happening here:</p>
<ul>
<li>Argo Rollouts Controller needs to know which Service is the <code>canaryService</code> and which is the <code>stableService</code> so it can update them to select their corresponding pods on the fly;</li>
<li>In order for us to know which pods are being selected by which service, we can specify a label or annotation to be attached to the Pods metadata via <code>canaryMetadata</code> and <code>stableMetadata</code>;</li>
<li>Argo Rollouts Controller also needs to know which Ingress is the <code>stableIngress</code> so it can create automatically the canary Ingress from it;</li>
<li>Finally, in order to avoid us from manually editing the Ingress‚Äôs <code>canary-weight</code> annotation, the Argo Rollouts Controller will be able to do it for us automatically, thanks to the <code>steps</code> specification.</li>
</ul>
<p>A <code>step</code> can be one of three things:</p>
<ol>
<li><code>pause</code>: this will put the Rollout in a Paused state. It can either be a timed pause (i.e. <code>duration: 5m</code>) or an indefinite pause, until it is manually resumed;</li>
<li><code>setWeight</code>: this will increase the canary Ingress‚Äôs <code>canary-weight</code> annotation to the desired weight (i.e. <code>setWeight: 25</code>);</li>
<li><code>setCanaryScale</code>: this will increase the number of replicas or pods which are selected by the canary Service (i.e. <code>setCanaryScale: 4</code>).</li>
</ol>
<h2 id="automating-incremental-rollouts">Automating Incremental Rollouts</h2>
<hr>
<p>Awesome! Now that our Rollout is up and we understand how it works under the hood, let‚Äôs take it for a spin! üöó</p>
<p>But first, let‚Äôs have a look at the dashboard!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl argo rollouts dashboard -n argo-rollouts <span class="p">&amp;</span>
</span></span></code></pre></div><p>If you now head to <a href="http://localhost:3100/rollout/sample-app">http://localhost:3100/rollout/sample-app</a>, you should see a shiny dashboard showing the state of the <code>sample-app</code> Rollout.</p>
<p><img src="/images/automated-canary-deployment/1.png" alt="Argo Rollouts Dashboard"></p>
<p>Cool! So far, we can observe only one <strong>revision</strong> labeled as <code>stable</code>, serving 100% of the traffic.</p>
<p>Now, let‚Äôs set a new image for the container and see what happens!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl argo rollouts <span class="nb">set</span> image sample-app sample-app<span class="o">=</span>ghcr.io/jhandguy/canary-deployment/sample-app:latest -n sample-app
</span></span></code></pre></div><p><img src="/images/automated-canary-deployment/2.png" alt="Argo Rollouts Dashboard"></p>
<p>Aha! A new <strong>revision</strong> has been created and was labeled as <code>canary</code>. The weight for the canary Ingress has been set to 25% and the <strong>Rollout</strong> has now entered the <em>Paused</em> state.</p>
<p>Let‚Äôs verify this real quick!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl get ingress -n sample-app
</span></span><span class="line"><span class="cl">NAME                           CLASS    HOSTS        ADDRESS     ...   
</span></span><span class="line"><span class="cl">sample-app                     &lt;none&gt;   sample.app   localhost   ...  
</span></span><span class="line"><span class="cl">sample-app-sample-app-canary   &lt;none&gt;   sample.app   localhost   ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">‚ûú kubectl describe ingress sample-app-sample-app-canary -n sample-app
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Annotations:  kubernetes.io/ingress.class: nginx
</span></span><span class="line"><span class="cl">              nginx.ingress.kubernetes.io/canary: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">              nginx.ingress.kubernetes.io/canary-by-header: X-Canary
</span></span><span class="line"><span class="cl">              nginx.ingress.kubernetes.io/canary-weight: <span class="m">25</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>Indeed! An extra Ingress resource was automatically created, and given a <code>canary-weight</code> of 25.</p>
<p>Let‚Äôs see if it works!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span></code></pre></div><p>As you can see, out of 4 requests, one came back from the <code>canary</code> pod.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-6bf6dfdbb4-xmqdw&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;stable&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">‚ûú curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-6bf6dfdbb4-xmqdw&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;stable&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">‚ûú curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-6bf6dfdbb4-xmqdw&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;stable&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">‚ûú curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-5c9fc8b7d4-wdrck&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;canary&#34;</span><span class="o">}</span>
</span></span></code></pre></div><p>And, the same way as in <a href="/posts/simple-canary-deployment/">Part 1</a>, we can easily <strong>Smoke Test</strong> our change in isolation by leveraging the Ingress <code>canary-by-header</code> annotation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span> -H <span class="s2">&#34;X-Canary: always&#34;</span>
</span></span></code></pre></div><p>Aha! We are now consistently hitting the <code>canary</code> pod.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span> -H <span class="s2">&#34;X-Canary: always&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-5c9fc8b7d4-wdrck&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;canary&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">‚ûú curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span> -H <span class="s2">&#34;X-Canary: always&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-5c9fc8b7d4-wdrck&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;canary&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">‚ûú curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span> -H <span class="s2">&#34;X-Canary: always&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-5c9fc8b7d4-wdrck&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;canary&#34;</span><span class="o">}</span>
</span></span></code></pre></div><h3 id="load-testing-with-k6">Load Testing with k6</h3>
<hr>
<p>Now we‚Äôve made a few requests, let‚Äôs see how it behaves under load and whether or not it indeed guarantees a rough 25/75 traffic split!</p>
<p>For Load Testing, I really recommend <a href="https://k6.io/docs/">k6</a> from the Grafana Labs team. It is a dead-simple yet super powerful tool with very extensive documentation.</p>
<p>See for yourself!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">k6 run k6/script.js
</span></span></code></pre></div><p>After about 1 minute, k6 should be done executing the load test and show you the results.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">          /<span class="se">\ </span>     <span class="p">|</span>‚Äæ‚Äæ<span class="p">|</span> /‚Äæ‚Äæ/   /‚Äæ‚Äæ/
</span></span><span class="line"><span class="cl">     /<span class="se">\ </span> /  <span class="se">\ </span>    <span class="p">|</span>  <span class="p">|</span>/  /   /  /
</span></span><span class="line"><span class="cl">    /  <span class="se">\/</span>    <span class="se">\ </span>   <span class="p">|</span>     <span class="o">(</span>   /   ‚Äæ‚Äæ<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   /          <span class="se">\ </span>  <span class="p">|</span>  <span class="p">|</span><span class="se">\ </span> <span class="se">\ </span><span class="p">|</span>  <span class="o">(</span>‚Äæ<span class="o">)</span>  <span class="p">|</span>
</span></span><span class="line"><span class="cl">  / __________ <span class="se">\ </span> <span class="p">|</span>__<span class="p">|</span> <span class="se">\_</span>_<span class="se">\ \_</span>____/ .io
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  execution: <span class="nb">local</span>
</span></span><span class="line"><span class="cl">     script: k6/script.js
</span></span><span class="line"><span class="cl">     output: -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  scenarios: <span class="o">(</span>100.00%<span class="o">)</span> <span class="m">1</span> scenario, <span class="m">20</span> max VUs, 1m30s max duration <span class="o">(</span>incl. graceful stop<span class="o">)</span>:
</span></span><span class="line"><span class="cl">           * load: Up to 20.00 iterations/s <span class="k">for</span> 1m0s over <span class="m">2</span> stages <span class="o">(</span>maxVUs: 20, gracefulStop: 30s<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     ‚úì status code is <span class="m">200</span>
</span></span><span class="line"><span class="cl">     ‚úì node is kind-control-plane
</span></span><span class="line"><span class="cl">     ‚úì namespace is sample-app
</span></span><span class="line"><span class="cl">     ‚úì pod is sample-app-*
</span></span><span class="line"><span class="cl">     ‚úì deployment is stable or canary
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   ‚úì checks.........................: 100.00% ‚úì <span class="m">3100</span>      ‚úó <span class="m">0</span>
</span></span><span class="line"><span class="cl">     data_received..................: <span class="m">157</span> kB  2.6 kB/s
</span></span><span class="line"><span class="cl">     data_sent......................: <span class="m">71</span> kB   1.2 kB/s
</span></span><span class="line"><span class="cl">     http_req_blocked...............: <span class="nv">avg</span><span class="o">=</span>42.6¬µs   <span class="nv">min</span><span class="o">=</span>2¬µs    <span class="nv">med</span><span class="o">=</span>15¬µs   <span class="nv">max</span><span class="o">=</span>2.44ms  p<span class="o">(</span>90<span class="o">)=</span>23¬µs   p<span class="o">(</span>95<span class="o">)=</span>36.29¬µs
</span></span><span class="line"><span class="cl">     http_req_connecting............: <span class="nv">avg</span><span class="o">=</span>20.73¬µs  <span class="nv">min</span><span class="o">=</span>0s     <span class="nv">med</span><span class="o">=</span>0s     <span class="nv">max</span><span class="o">=</span>1.49ms  p<span class="o">(</span>90<span class="o">)=</span>0s     p<span class="o">(</span>95<span class="o">)=</span>0s
</span></span><span class="line"><span class="cl">   ‚úì http_req_duration..............: <span class="nv">avg</span><span class="o">=</span>4.73ms   <span class="nv">min</span><span class="o">=</span>829¬µs  <span class="nv">med</span><span class="o">=</span>4.09ms <span class="nv">max</span><span class="o">=</span>36.81ms p<span class="o">(</span>90<span class="o">)=</span>7.89ms p<span class="o">(</span>95<span class="o">)=</span>10.14ms
</span></span><span class="line"><span class="cl">       <span class="o">{</span> expected_response:true <span class="o">}</span>...: <span class="nv">avg</span><span class="o">=</span>4.73ms   <span class="nv">min</span><span class="o">=</span>829¬µs  <span class="nv">med</span><span class="o">=</span>4.09ms <span class="nv">max</span><span class="o">=</span>36.81ms p<span class="o">(</span>90<span class="o">)=</span>7.89ms p<span class="o">(</span>95<span class="o">)=</span>10.14ms
</span></span><span class="line"><span class="cl">     http_req_failed................: 0.00%   ‚úì <span class="m">0</span>         ‚úó <span class="m">620</span>
</span></span><span class="line"><span class="cl">     http_req_rate..................: 50.00%  ‚úì <span class="m">620</span>       ‚úó <span class="m">620</span>
</span></span><span class="line"><span class="cl">     ‚úì <span class="o">{</span> deployment:canary <span class="o">}</span>........: 28.70%  ‚úì <span class="m">178</span>       ‚úó <span class="m">442</span>
</span></span><span class="line"><span class="cl">     ‚úì <span class="o">{</span> deployment:stable <span class="o">}</span>........: 71.29%  ‚úì <span class="m">442</span>       ‚úó <span class="m">178</span>
</span></span><span class="line"><span class="cl">     http_req_receiving.............: <span class="nv">avg</span><span class="o">=</span>129.17¬µs <span class="nv">min</span><span class="o">=</span>21¬µs   <span class="nv">med</span><span class="o">=</span>128¬µs  <span class="nv">max</span><span class="o">=</span>2.05ms  p<span class="o">(</span>90<span class="o">)=</span>186¬µs  p<span class="o">(</span>95<span class="o">)=</span>214.04¬µs
</span></span><span class="line"><span class="cl">     http_req_sending...............: <span class="nv">avg</span><span class="o">=</span>65.53¬µs  <span class="nv">min</span><span class="o">=</span>11¬µs   <span class="nv">med</span><span class="o">=</span>62¬µs   <span class="nv">max</span><span class="o">=</span>1.96ms  p<span class="o">(</span>90<span class="o">)=</span>92.1¬µs p<span class="o">(</span>95<span class="o">)=</span>104.04¬µs
</span></span><span class="line"><span class="cl">     http_req_tls_handshaking.......: <span class="nv">avg</span><span class="o">=</span>0s       <span class="nv">min</span><span class="o">=</span>0s     <span class="nv">med</span><span class="o">=</span>0s     <span class="nv">max</span><span class="o">=</span>0s      p<span class="o">(</span>90<span class="o">)=</span>0s     p<span class="o">(</span>95<span class="o">)=</span>0s
</span></span><span class="line"><span class="cl">     http_req_waiting...............: <span class="nv">avg</span><span class="o">=</span>4.53ms   <span class="nv">min</span><span class="o">=</span>774¬µs  <span class="nv">med</span><span class="o">=</span>3.88ms <span class="nv">max</span><span class="o">=</span>36.6ms  p<span class="o">(</span>90<span class="o">)=</span>7.7ms  p<span class="o">(</span>95<span class="o">)=</span>9.73ms
</span></span><span class="line"><span class="cl">     http_reqs......................: <span class="m">620</span>     10.333024/s
</span></span><span class="line"><span class="cl">     iteration_duration.............: <span class="nv">avg</span><span class="o">=</span>5.4ms    <span class="nv">min</span><span class="o">=</span>1.07ms <span class="nv">med</span><span class="o">=</span>4.81ms <span class="nv">max</span><span class="o">=</span>38.46ms p<span class="o">(</span>90<span class="o">)=</span>8.76ms p<span class="o">(</span>95<span class="o">)=</span>10.76ms
</span></span><span class="line"><span class="cl">     iterations.....................: <span class="m">620</span>     10.333024/s
</span></span><span class="line"><span class="cl">     vus............................: <span class="m">0</span>       <span class="nv">min</span><span class="o">=</span><span class="m">0</span>       <span class="nv">max</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">     vus_max........................: <span class="m">20</span>      <span class="nv">min</span><span class="o">=</span><span class="m">20</span>      <span class="nv">max</span><span class="o">=</span><span class="m">20</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">running <span class="o">(</span>1m00.0s<span class="o">)</span>, 00/20 VUs, <span class="m">620</span> <span class="nb">complete</span> and <span class="m">0</span> interrupted iterations
</span></span><span class="line"><span class="cl">load ‚úì <span class="o">[======================================]</span> 00/20 VUs  1m0s  00.71 iters/s
</span></span></code></pre></div><p>That sounds about right!<br>
Out of 620 requests, 178 (28%) were served by the <code>canary</code> Deployment while 442 (72%) were served by the <code>stable</code> one. Pretty good!</p>
<h3 id="promoting-rollouts">Promoting Rollouts</h3>
<hr>
<p>Once feeling confident enough to proceed to the next <code>step</code>, we can now <strong>promote</strong> our Rollout, either from the dashboard via the <em>PROMOTE</em> button, or via the Kubectl Plugin.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl argo rollouts promote sample-app -n sample-app
</span></span></code></pre></div><p><img src="/images/automated-canary-deployment/3.png" alt="Argo Rollouts Dashboard"></p>
<blockquote>
<p><em>Note: while the rollout is ongoing, keep firing some curl requests or run the k6 Load Test script again to observe the change in traffic distribution!</em></p>
</blockquote>
<p>And if feeling so confident that we want to skip all the Rollout <code>steps</code> and get straight to 100% canary traffic, then we can <strong>fully promote</strong> the Rollout, also either from the dashboard via the <em>PROMOTE-FULL</em> button, or from the command line.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl argo rollouts promote sample-app -n sample-app --full
</span></span></code></pre></div><p>But if on the contrary, we found an issue while in the middle of rolling out a change, then we can easily <strong>abort</strong> the Rollout and return to 100% stable traffic, either from the dashboard via the <em>ABORT</em> button, or from the CLI.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl argo rollouts abort sample-app -n sample-app
</span></span></code></pre></div><p>Finally, once the Rollout is complete and if something were to go wrong, just like one would do with a standard Deployment, we can easily <strong>undo</strong> a Rollout and roll it back to the previous revision, also either from the dashboard via the <em>ROLLBACK</em> button, or via Kubectl.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl argo rollouts undo sample-app -n sample-app
</span></span></code></pre></div><h2 id="wrapping-up">Wrapping up</h2>
<hr>
<p>That‚Äôs it! You can now delete your Kind cluster.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kind delete cluster
</span></span></code></pre></div><p>To summarize, using Argo Rollouts we were able to:</p>
<ul>
<li>Improve our Canary Deployment setup, by leveraging the Rollout custom resource, without which duplicated Deployment and Ingress resources would have to be created;</li>
<li>Automate the Traffic Routing increments via Rollout <code>steps</code>, which would otherwise have to be done manually by editing the canary Ingress annotation directly.</li>
</ul>
<p>Was it worth it? Did that help you understand how to implement Canary Deployment in Kubernetes using Argo Rollouts?</p>
<p>If so, follow me on <a href="https://twitter.com/jhandguy">Twitter</a>, I‚Äôll be happy to answer any of your questions and you‚Äôll be the first one to know when a new article comes out! üëå</p>
<p>See you next week, for Part 3 of my series <strong>Canary Deployment in Kubernetes</strong>!</p>
<p>Bye-bye! üëã</p>

        </div>
    </div>
</section>

</body>
<footer>
    <div class="footer pt-3 has-background-black-bis">
        <div class="container pb-6 has-text-centered is-mobile columns">
            <div class="column is-narrow paddingless">
                
                
                <a class="button is-large" href="https://jhandguy.github.io/posts/simple-canary-deployment/"><strong>üëà</strong></a>
                
                
            </div>
            <div class="column"></div>
            <div class="column is-narrow paddingless">
                <a class="button is-large" href="#"><strong>üëÜ</strong></a>
            </div>
            <div class="column"></div>
            <div class="column is-narrow paddingless">
                
                
                <a class="button is-large" href="https://jhandguy.github.io/posts/smart-canary-deployment/"><strong>üëâ</strong></a>
                
                
            </div>
        </div>
        <div class="content has-text-centered">
            <p class="subtitle is-6">Powered by <a href="https://gohugo.io/">Hugo</a></p>
            <a href="https://bulma.io">
                <img src="/images/footer/made-with-bulma.png" alt="Made with Bulma" width="128" height="24">
            </a>
        </div>
    </div>
</footer>

</html>
