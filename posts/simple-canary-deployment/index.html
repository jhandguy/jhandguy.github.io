<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Canary Deployment in Kubernetes (Part 1) — Simple Canary Deployment using Ingress NGINX</title>
    <link rel="stylesheet" href="/css/bulma.min.css">
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="stylesheet" href="/css/hugo.css">
</head>

<body>
<nav class="navbar">
    <div class="navbar-brand">
        <a class="navbar-item" href="/">
            Home
        </a>

        <div class="navbar-item">
            <a class="button is-link" href="/about">
                <strong>About me</strong>
            </a>
        </div>
    </div>
</nav>

<section class="section">
    <div class="container is-max-desktop">
        <div class="content">
            <p class="title is-spaced">Canary Deployment in Kubernetes (Part 1) — Simple Canary Deployment using Ingress NGINX</p>
            
            
            <div class="box">
                <p class="subtitle">Table of Contents</p>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#creating-kind-cluster">Creating Kind Cluster</a></li>
    <li><a href="#installing-nginx-ingress-controller">Installing NGINX Ingress Controller</a></li>
    <li><a href="#configuring-ingress-canary-annotations">Configuring Ingress Canary Annotations</a></li>
    <li><a href="#rolling-out-canary-deployments-incrementally">Rolling-out Canary Deployments Incrementally</a>
      <ul>
        <li><a href="#load-testing-with-k6">Load Testing with k6</a></li>
      </ul>
    </li>
    <li><a href="#wrapping-up">Wrapping up</a></li>
  </ul>
</nav>
            </div>
            
            
        </div>
    </div>
    <div class="container is-max-desktop mt-6">
        <div class="content has-text-justified-tablet">
            <p>Deploying to production in Kubernetes can be quite stressful. Even after meaningful and reliable automated tests have successfully passed, there is still room for things to go wrong and lead to a nasty incident when pressing the final button.</p>
<p>Thankfully, Kubernetes is made to be resilient to this kind of scenario, and rolling back is a no-brainer. But still, rolling back means that, at least for some time, <strong>all of the users</strong> were negatively impacted by the faulty change…</p>
<p>What if we could smoke test our change in production <strong>before</strong> it actually hits real users? What if we could roll out a change incrementally to <strong>some users</strong> instead of all of them at once? What if we could detect a faulty deployment and roll it back automatically?<br>
Well, that, my friend, is what Canary Deployment is all about!</p>
<blockquote>
<p>Minimizing the impact on real users while deploying a risky change to production.</p>
</blockquote>
<p>🎬 Hi there, I’m Jean!</p>
<p>In this 3 parts series, we’re going to explore several ways to do Canary Deployment in Kubernetes, and the first one is…<br>
🥁<br>
… using <strong>Ingress NGINX</strong>! 🎊</p>
<h2 id="requirements">Requirements</h2>
<hr>
<p>Before we start, make sure you have the following tools installed:</p>
<ul>
<li><a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation">Kind</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/">Kubectl</a></li>
<li><a href="https://helm.sh/docs/intro/install/">Helm</a></li>
<li><a href="https://k6.io/docs/getting-started/installation/">K6</a></li>
</ul>
<blockquote>
<p><em>Note: for MacOS users or Linux users using Homebrew, simply run:</em><br>
<code>brew install kind kubectl helm k6</code></p>
</blockquote>
<p>All set? Let’s go! 🏁</p>
<h2 id="creating-kind-cluster">Creating Kind Cluster</h2>
<hr>
<p><a href="https://kind.sigs.k8s.io/">Kind</a> is a tool for running local Kubernetes clusters using Docker container “nodes”.
It was primarily designed for testing Kubernetes itself, but may be used for local development or CI.</p>
<p>I don’t expect you to have a demo project in handy, so <a href="https://github.com/jhandguy/canary-deployment">I built one</a> for you.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git clone https://github.com/jhandguy/canary-deployment.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> canary-deployment
</span></span></code></pre></div><p>Alright, let&rsquo;s spin up our Kind cluster! 🚀</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ kind create cluster --image kindest/node:v1.27.3 --config<span class="o">=</span>kind/cluster.yaml
</span></span><span class="line"><span class="cl">Creating cluster <span class="s2">&#34;kind&#34;</span> ...
</span></span><span class="line"><span class="cl"> ✓ Ensuring node image <span class="o">(</span>kindest/node:v1.27.3<span class="o">)</span> 🖼
</span></span><span class="line"><span class="cl"> ✓ Preparing nodes 📦
</span></span><span class="line"><span class="cl"> ✓ Writing configuration 📜
</span></span><span class="line"><span class="cl"> ✓ Starting control-plane 🕹️
</span></span><span class="line"><span class="cl"> ✓ Installing CNI 🔌
</span></span><span class="line"><span class="cl"> ✓ Installing StorageClass 💾
</span></span><span class="line"><span class="cl">Set kubectl context to <span class="s2">&#34;kind-kind&#34;</span>
</span></span><span class="line"><span class="cl">You can now use your cluster with:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl cluster-info --context kind-kind
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community 🙂
</span></span></code></pre></div><h2 id="installing-nginx-ingress-controller">Installing NGINX Ingress Controller</h2>
<hr>
<p><a href="https://github.com/kubernetes/ingress-nginx">NGINX Ingress Controller</a> is one of the <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/#additional-controllers">many available Kubernetes Ingress Controllers</a>, which acts as a load balancer and satisfies routing rules specified in <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#what-is-ingress">Ingress</a> resources, using the <a href="https://nginx.org/en/">NGINX reverse proxy</a>.</p>
<p>NGINX Ingress Controller can be installed via its <a href="https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx">Helm chart</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
</span></span><span class="line"><span class="cl">helm install ingress-nginx/ingress-nginx --name-template ingress-nginx --create-namespace -n ingress-nginx --values kind/ingress-nginx-values.yaml --version 4.8.3 --wait
</span></span></code></pre></div><p>Now, if everything goes according to plan, you should be able to see the <strong>ingress-nginx-controller</strong> Deployment running.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ kubectl get deploy -n ingress-nginx
</span></span><span class="line"><span class="cl">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">ingress-nginx-controller   1/1     <span class="m">1</span>            <span class="m">1</span>           4m35s
</span></span></code></pre></div><h2 id="configuring-ingress-canary-annotations">Configuring Ingress Canary Annotations</h2>
<hr>
<p>Now that our NGINX Ingress Controller is up and running, let’s get into the thick of it, shall we? 🧐</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm install sample-app/helm-charts/ingress-nginx --name-template sample-app --create-namespace -n sample-app --wait
</span></span></code></pre></div><p>If everything goes fine, you should eventually see two Deployments with the READY state.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ kubectl get deploy -n sample-app
</span></span><span class="line"><span class="cl">NAME                READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">sample-app          1/1     <span class="m">1</span>            <span class="m">1</span>           100s
</span></span><span class="line"><span class="cl">sample-app-canary   1/1     <span class="m">1</span>            <span class="m">1</span>           100s
</span></span></code></pre></div><p>Alright, let’s take a look at what’s under all this!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ ls -1 sample-app/helm-charts/ingress-nginx/templates
</span></span><span class="line"><span class="cl">canary
</span></span><span class="line"><span class="cl">deployment.yaml
</span></span><span class="line"><span class="cl">ingress.yaml
</span></span><span class="line"><span class="cl">service.yaml
</span></span><span class="line"><span class="cl">serviceaccount.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ ls -1 sample-app/helm-charts/ingress-nginx/templates/canary
</span></span><span class="line"><span class="cl">deployment.yaml
</span></span><span class="line"><span class="cl">ingress.yaml
</span></span><span class="line"><span class="cl">service.yaml
</span></span></code></pre></div><p>As you can see, most of the resources have been duplicated, except for the <code>serviceaccount.yaml</code>:</p>
<ul>
<li>The <code>deployment.yaml</code> and the <code>canary/deployment.yaml</code> are strictly the same, apart from the name and the image tag.</li>
<li>The <code>service.yaml</code> and the <code>canary/service.yaml</code> are also very much the same, except for the name and the label selector.</li>
</ul>
<p>This is actually for a simple reason: in the end, the stable and the canary deployments are meant to be very much alike, apart from the image built inside the container, exactly like for a <a href="https://www.redhat.com/en/topics/devops/what-is-blue-green-deployment">blue/green deployment</a>.</p>
<p>Now, the <code>ingress.yaml</code> and the <code>canary/ingress.yaml</code> are similar, but not very much the same though: you’ll notice some extra <a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/">annotations</a> in the <code>canary/ingress.yaml</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary-weight</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ .Values.canary.weight }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/canary-by-header</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;X-Canary&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>This is where the magic happens! 🪄</p>
</blockquote>
<p>Let’s dive into each of these <a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/">annotations</a> real quick:</p>
<ul>
<li><strong><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#canary">nginx.ingress.kubernetes.io/canary</a></strong><br>
When set to <code>&quot;true&quot;</code>, this will let the Ingress Controller know that this is the Ingress routing traffic to the canary Deployment.</li>
<li><strong><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#canary">nginx.ingress.kubernetes.io/canary-weight</a></strong><br>
When given a value, this will tell the Ingress Controller how to split traffic between the stable and the canary Deployments.
For instance, a weight of <code>50</code> would result in a 50/50 split.</li>
<li><strong><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#canary">nginx.ingress.kubernetes.io/canary-by-header</a></strong><br>
When given a key, this will allow us to force a request into hitting the canary or the stable deployment, no matter the <code>canary-weight</code>.
By using the header value <code>always</code>, the request will always land in the canary Deployment, and when using the value <code>never</code>, the request will always land in the stable one.</li>
</ul>
<p>Right now, the <code>canary-weight</code> is <code>0</code> and the <code>canary-by-header</code> is <code>X-Canary</code>. This means that normal requests will never land in the canary Deployment unless a header <code>X-Canary: always</code> is passed to the request.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ kubectl describe ingress sample-app-canary -n sample-app
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Annotations:  ...
</span></span><span class="line"><span class="cl">              nginx.ingress.kubernetes.io/canary: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">              nginx.ingress.kubernetes.io/canary-by-header: X-Canary
</span></span><span class="line"><span class="cl">              nginx.ingress.kubernetes.io/canary-weight: <span class="m">0</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>Let’s give it a try!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span></code></pre></div><p>As you can see, no matter how many times you run this command, the <code>pod</code> will always be the same. In fact, this is the <code>stable</code> pod.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-6bd9dc6d5d-jstn2&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;stable&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-6bd9dc6d5d-jstn2&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;stable&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-6bd9dc6d5d-jstn2&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;stable&#34;</span><span class="o">}</span>
</span></span></code></pre></div><p>This is due to the fact that the current <code>canary-weight</code> is <code>0</code> thus 100% of the traffic will normally go to the <code>stable</code> Deployment.</p>
<p>Now let’s try with the <code>X-Canary: always</code> header!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span> -H <span class="s2">&#34;X-Canary: always&#34;</span>
</span></span></code></pre></div><p>Aha! We are now consistently hitting the <code>canary</code> pod.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span> -H <span class="s2">&#34;X-Canary: always&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-canary-b559b9d75-gfvxp&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;canary&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span> -H <span class="s2">&#34;X-Canary: always&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-canary-b559b9d75-gfvxp&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;canary&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span> -H <span class="s2">&#34;X-Canary: always&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-canary-b559b9d75-gfvxp&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;canary&#34;</span><span class="o">}</span>
</span></span></code></pre></div><p>Did you pay attention to what we just did? 😉<br>
This has a name: <strong>Smoke Testing</strong>! 🔥</p>
<p>That’s right, we just smoke-tested a change, in production, while isolating it from the rest of the users as normal requests are routed to the <code>stable</code> Deployment thanks to the <code>canary-weight</code>. However, we bypassed that during Smoke Testing by utilizing the <code>canary-by-header</code> to force the request into hitting the <code>canary</code> Deployment.<br>
Isn’t that awesome?! No more panic attacks when smoke tests fail on Canary, your users aren’t affected. 😌</p>
<h2 id="rolling-out-canary-deployments-incrementally">Rolling-out Canary Deployments Incrementally</h2>
<hr>
<p>So we have solved one problem, yet one remains: How do we expose a change to our real users incrementally, to minimize the impact if something goes south?</p>
<p>Well, you’ve probably guessed it, <code>canary-weight</code> to the rescue! 🚀</p>
<p>We can simply slowly increase the <code>canary-weight</code> in order to let <strong>some</strong> users being routed to the <code>canary</code> Deployment. Let’s give it a try!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm upgrade sample-app sample-app/helm-charts/ingress-nginx -n sample-app --reuse-values --set canary.weight<span class="o">=</span><span class="m">50</span> --wait
</span></span></code></pre></div><p>Let’s verify that our <code>canary</code> Ingress now has a <code>canary-weight</code> of <code>50</code>!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ kubectl describe ingress sample-app-canary -n sample-app
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Annotations:  ...
</span></span><span class="line"><span class="cl">              nginx.ingress.kubernetes.io/canary: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">              nginx.ingress.kubernetes.io/canary-by-header: X-Canary
</span></span><span class="line"><span class="cl">              nginx.ingress.kubernetes.io/canary-weight: <span class="m">50</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>All good, let’s test it out!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span></code></pre></div><p>As you can see, traffic is now equally split between the <code>stable</code> and <code>canary</code> Deployments.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-6bd9dc6d5d-jstn2&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;stable&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-canary-5754f4bbc7-lvthj&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;canary&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-6bd9dc6d5d-jstn2&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;stable&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;node&#34;</span>:<span class="s2">&#34;kind-control-plane&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;sample-app&#34;</span>,<span class="s2">&#34;pod&#34;</span>:<span class="s2">&#34;sample-app-canary-5754f4bbc7-lvthj&#34;</span>,<span class="s2">&#34;deployment&#34;</span>:<span class="s2">&#34;canary&#34;</span><span class="o">}</span>
</span></span></code></pre></div><h3 id="load-testing-with-k6">Load Testing with k6</h3>
<hr>
<p>Now we’ve made a few requests, let’s see how it behaves under load and whether or not it indeed guarantees about 50% traffic distribution!</p>
<p>For Load Testing, I really recommend <a href="https://k6.io/docs/">k6</a> from the Grafana Labs team. It is a dead-simple yet super powerful tool with very extensive documentation.</p>
<p>See for yourself!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">k6 run k6/script.js
</span></span></code></pre></div><p>After about 1 minute, k6 should be done executing the load test and show you the results.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">          /<span class="se">\ </span>     <span class="p">|</span>‾‾<span class="p">|</span> /‾‾/   /‾‾/
</span></span><span class="line"><span class="cl">     /<span class="se">\ </span> /  <span class="se">\ </span>    <span class="p">|</span>  <span class="p">|</span>/  /   /  /
</span></span><span class="line"><span class="cl">    /  <span class="se">\/</span>    <span class="se">\ </span>   <span class="p">|</span>     <span class="o">(</span>   /   ‾‾<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   /          <span class="se">\ </span>  <span class="p">|</span>  <span class="p">|</span><span class="se">\ </span> <span class="se">\ </span><span class="p">|</span>  <span class="o">(</span>‾<span class="o">)</span>  <span class="p">|</span>
</span></span><span class="line"><span class="cl">  / __________ <span class="se">\ </span> <span class="p">|</span>__<span class="p">|</span> <span class="se">\_</span>_<span class="se">\ \_</span>____/ .io
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  execution: <span class="nb">local</span>
</span></span><span class="line"><span class="cl">     script: k6/script.js
</span></span><span class="line"><span class="cl">     output: -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  scenarios: <span class="o">(</span>100.00%<span class="o">)</span> <span class="m">1</span> scenario, <span class="m">20</span> max VUs, 1m30s max duration <span class="o">(</span>incl. graceful stop<span class="o">)</span>:
</span></span><span class="line"><span class="cl">           * load: Up to 20.00 iterations/s <span class="k">for</span> 1m0s over <span class="m">2</span> stages <span class="o">(</span>maxVUs: 20, gracefulStop: 30s<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     ✓ status code is <span class="m">200</span>
</span></span><span class="line"><span class="cl">     ✓ node is kind-control-plane
</span></span><span class="line"><span class="cl">     ✓ namespace is sample-app
</span></span><span class="line"><span class="cl">     ✓ pod is sample-app-*
</span></span><span class="line"><span class="cl">     ✓ deployment is stable or canary
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   ✓ checks.........................: 100.00% ✓ <span class="m">3095</span>      ✗ <span class="m">0</span>
</span></span><span class="line"><span class="cl">     data_received..................: <span class="m">160</span> kB  2.7 kB/s
</span></span><span class="line"><span class="cl">     data_sent......................: <span class="m">71</span> kB   1.2 kB/s
</span></span><span class="line"><span class="cl">     http_req_blocked...............: <span class="nv">avg</span><span class="o">=</span>48.21µs  <span class="nv">min</span><span class="o">=</span>3µs    <span class="nv">med</span><span class="o">=</span>18µs   <span class="nv">max</span><span class="o">=</span>2.38ms  p<span class="o">(</span>90<span class="o">)=</span>23µs   p<span class="o">(</span>95<span class="o">)=</span>30.09µs
</span></span><span class="line"><span class="cl">     http_req_connecting............: <span class="nv">avg</span><span class="o">=</span>24.56µs  <span class="nv">min</span><span class="o">=</span>0s     <span class="nv">med</span><span class="o">=</span>0s     <span class="nv">max</span><span class="o">=</span>1.48ms  p<span class="o">(</span>90<span class="o">)=</span>0s     p<span class="o">(</span>95<span class="o">)=</span>0s
</span></span><span class="line"><span class="cl">   ✓ http_req_duration..............: <span class="nv">avg</span><span class="o">=</span>4.87ms   <span class="nv">min</span><span class="o">=</span>800µs  <span class="nv">med</span><span class="o">=</span>4.24ms <span class="nv">max</span><span class="o">=</span>34.52ms p<span class="o">(</span>90<span class="o">)=</span>7.85ms p<span class="o">(</span>95<span class="o">)=</span>9.88ms
</span></span><span class="line"><span class="cl">       <span class="o">{</span> expected_response:true <span class="o">}</span>...: <span class="nv">avg</span><span class="o">=</span>4.87ms   <span class="nv">min</span><span class="o">=</span>800µs  <span class="nv">med</span><span class="o">=</span>4.24ms <span class="nv">max</span><span class="o">=</span>34.52ms p<span class="o">(</span>90<span class="o">)=</span>7.85ms p<span class="o">(</span>95<span class="o">)=</span>9.88ms
</span></span><span class="line"><span class="cl">     http_req_failed................: 0.00%   ✓ <span class="m">0</span>         ✗ <span class="m">619</span>
</span></span><span class="line"><span class="cl">     http_req_rate..................: 50.00%  ✓ <span class="m">619</span>       ✗ <span class="m">619</span>
</span></span><span class="line"><span class="cl">     ✓ <span class="o">{</span> deployment:canary <span class="o">}</span>........: 47.65%  ✓ <span class="m">295</span>       ✗ <span class="m">324</span>
</span></span><span class="line"><span class="cl">     ✓ <span class="o">{</span> deployment:stable <span class="o">}</span>........: 52.34%  ✓ <span class="m">324</span>       ✗ <span class="m">295</span>
</span></span><span class="line"><span class="cl">     http_req_receiving.............: <span class="nv">avg</span><span class="o">=</span>132.17µs <span class="nv">min</span><span class="o">=</span>24µs   <span class="nv">med</span><span class="o">=</span>136µs  <span class="nv">max</span><span class="o">=</span>610µs   p<span class="o">(</span>90<span class="o">)=</span>179µs  p<span class="o">(</span>95<span class="o">)=</span>213.09µs
</span></span><span class="line"><span class="cl">     http_req_sending...............: <span class="nv">avg</span><span class="o">=</span>70.69µs  <span class="nv">min</span><span class="o">=</span>15µs   <span class="nv">med</span><span class="o">=</span>72µs   <span class="nv">max</span><span class="o">=</span>736µs   p<span class="o">(</span>90<span class="o">)=</span>94.2µs p<span class="o">(</span>95<span class="o">)=</span>101µs
</span></span><span class="line"><span class="cl">     http_req_tls_handshaking.......: <span class="nv">avg</span><span class="o">=</span>0s       <span class="nv">min</span><span class="o">=</span>0s     <span class="nv">med</span><span class="o">=</span>0s     <span class="nv">max</span><span class="o">=</span>0s      p<span class="o">(</span>90<span class="o">)=</span>0s     p<span class="o">(</span>95<span class="o">)=</span>0s
</span></span><span class="line"><span class="cl">     http_req_waiting...............: <span class="nv">avg</span><span class="o">=</span>4.67ms   <span class="nv">min</span><span class="o">=</span>719µs  <span class="nv">med</span><span class="o">=</span>4.02ms <span class="nv">max</span><span class="o">=</span>34.2ms  p<span class="o">(</span>90<span class="o">)=</span>7.64ms p<span class="o">(</span>95<span class="o">)=</span>9.65ms
</span></span><span class="line"><span class="cl">     http_reqs......................: <span class="m">619</span>     10.316511/s
</span></span><span class="line"><span class="cl">     iteration_duration.............: <span class="nv">avg</span><span class="o">=</span>5.59ms   <span class="nv">min</span><span class="o">=</span>1.08ms <span class="nv">med</span><span class="o">=</span>5.02ms <span class="nv">max</span><span class="o">=</span>41.22ms p<span class="o">(</span>90<span class="o">)=</span>8.68ms p<span class="o">(</span>95<span class="o">)=</span>10.52ms
</span></span><span class="line"><span class="cl">     iterations.....................: <span class="m">619</span>     10.316511/s
</span></span><span class="line"><span class="cl">     vus............................: <span class="m">0</span>       <span class="nv">min</span><span class="o">=</span><span class="m">0</span>       <span class="nv">max</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">     vus_max........................: <span class="m">20</span>      <span class="nv">min</span><span class="o">=</span><span class="m">20</span>      <span class="nv">max</span><span class="o">=</span><span class="m">20</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">running <span class="o">(</span>1m00.0s<span class="o">)</span>, 00/20 VUs, <span class="m">619</span> <span class="nb">complete</span> and <span class="m">0</span> interrupted iterations
</span></span><span class="line"><span class="cl">load ✓ <span class="o">[======================================]</span> 00/20 VUs  1m0s  00.71 iters/s
</span></span></code></pre></div><p>That sounds about right!<br>
Out of 619 requests, 295 (48%) were served by the <code>canary</code> Deployment while 324 (52%) were served by the <code>stable</code> one. Pretty good!</p>
<h2 id="wrapping-up">Wrapping up</h2>
<hr>
<p>That’s it! You can now delete your Kind cluster.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kind delete cluster
</span></span></code></pre></div><p>To summarize, using Ingress NGINX we were able to:</p>
<ul>
<li>Smoke test our change in complete isolation from the rest of the users;</li>
<li>Incrementally expose our change to <strong>some</strong> users to minimize risk.</li>
</ul>
<p>Was it worth it? Did that help you understand how to implement Canary Deployment in Kubernetes using Ingress NGINX?</p>
<p>If so, follow me on <a href="https://twitter.com/jhandguy">Twitter</a>, I’ll be happy to answer any of your questions and you’ll be the first one to know when a new article comes out! 👌</p>
<p>See you next week, for Part 2 of my series <strong>Canary Deployment in Kubernetes</strong>!</p>
<p>Bye-bye! 👋</p>

        </div>
    </div>
</section>

</body>
<footer>
    <div class="footer pt-3 has-background-black-bis">
        <div class="container pb-6 has-text-centered is-mobile columns">
            <div class="column is-narrow paddingless">
                
                
                <a class="button is-large" href="https://jhandguy.github.io/posts/path-to-cicd-nirvana-ios/"><strong>👈</strong></a>
                
                
            </div>
            <div class="column"></div>
            <div class="column is-narrow paddingless">
                <a class="button is-large" href="#"><strong>👆</strong></a>
            </div>
            <div class="column"></div>
            <div class="column is-narrow paddingless">
                
                
                <a class="button is-large" href="https://jhandguy.github.io/posts/automated-canary-deployment/"><strong>👉</strong></a>
                
                
            </div>
        </div>
        <div class="content has-text-centered">
            <p class="subtitle is-6">Powered by <a href="https://gohugo.io/">Hugo</a></p>
            <a href="https://bulma.io">
                <img src="/images/footer/made-with-bulma.png" alt="Made with Bulma" width="128" height="24">
            </a>
        </div>
    </div>
</footer>

</html>
