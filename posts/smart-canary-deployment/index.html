<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Canary Deployment in Kubernetes (Part 3) â€” Smart Canary Deployment using Argo Rollouts and Prometheus</title>
    <link rel="stylesheet" href="/css/bulma.min.css">
    <link rel="stylesheet" href="/css/custom.css">
</head>

<body>
<nav class="navbar">
    <div class="navbar-brand">
        <a class="navbar-item" href="/">
            Home
        </a>

        <div class="navbar-item">
            <a class="button is-link" href="/about">
                <strong>About me</strong>
            </a>
        </div>
    </div>
</nav>

<section class="section">
    <div class="container is-max-desktop">
        <div class="content">
            <p class="title is-spaced">Canary Deployment in Kubernetes (Part 3) â€” Smart Canary Deployment using Argo Rollouts and Prometheus</p>
            
            
            <div class="box">
                <p class="subtitle">Table of Contents</p>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#creating-kind-cluster">Creating Kind Cluster</a></li>
    <li><a href="#using-argo-rollouts-with-prometheus">Using Argo Rollouts with Prometheus</a>
      <ul>
        <li><a href="#installing-nginx-ingress-controller">Installing NGINX Ingress Controller</a></li>
        <li><a href="#installing-argo-rollouts">Installing Argo Rollouts</a></li>
        <li><a href="#installing-prometheus">Installing Prometheus</a></li>
      </ul>
    </li>
    <li><a href="#automating-rollbacks-using-analysistemplates">Automating Rollbacks using AnalysisTemplates</a></li>
    <li><a href="#detecting-and-aborting-rollouts-automatically">Detecting and Aborting Rollouts Automatically</a>
      <ul>
        <li><a href="#load-testing-with-k6">Load Testing with k6</a></li>
      </ul>
    </li>
    <li><a href="#wrapping-up">Wrapping up</a></li>
  </ul>
</nav>
            </div>
            
            
        </div>
    </div>
    <div class="container is-max-desktop mt-6">
        <div class="content has-text-justified-tablet">
            <p>Deploying to production in Kubernetes can be quite stressful. Even after meaningful and reliable automated tests have successfully passed, there is still room for things to go wrong and lead to a nasty incident when pressing the final button.</p>
<p>Thankfully, Kubernetes is made to be resilient to this kind of scenario, and rolling back is a no-brainer. But still, rolling back means that, at least for some time, <strong>all of the users</strong> were negatively impacted by the faulty changeâ€¦</p>
<p>What if we could smoke test our change in production <strong>before</strong> it actually hits real users? What if we could roll out a change incrementally to <strong>some users</strong> instead of all of them at once? What if we could detect a faulty deployment and roll it back automatically?<br>
Well, that, my friend, is what Canary Deployment is all about!</p>
<blockquote>
<p>Minimizing the impact on real users while deploying a risky change to production.</p>
</blockquote>
<p>ğŸ¬ Hi there, Iâ€™m Jean!</p>
<p>In this 3 parts series, weâ€™re going to explore several ways to do Canary Deployment in Kubernetes, and the first one isâ€¦<br>
ğŸ¥<br>
â€¦ using <strong>Argo Rollouts and Prometheus</strong>! ğŸŠ</p>
<h2 id="requirements">Requirements</h2>
<hr>
<p>Before we start, make sure you have the following tools installed:</p>
<ul>
<li><a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation">Kind</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/">Kubectl</a></li>
<li><a href="https://argoproj.github.io/argo-rollouts/installation/#kubectl-plugin-installation">Argo Rollouts Kubectl Plugin</a></li>
<li><a href="https://helm.sh/docs/intro/install/">Helm</a></li>
<li><a href="https://k6.io/docs/getting-started/installation/">K6</a></li>
</ul>
<blockquote>
<p><em>Note: for MacOS users or Linux users using Homebrew, simply run:</em><br>
<code>brew install kind kubectl argoproj/tap/kubectl-argo-rollouts helm k6</code></p>
</blockquote>
<p>All set? Letâ€™s go! ğŸ</p>
<h2 id="creating-kind-cluster">Creating Kind Cluster</h2>
<hr>
<p><a href="https://kind.sigs.k8s.io/">Kind</a> is a tool for running local Kubernetes clusters using Docker container â€œnodesâ€.
It was primarily designed for testing Kubernetes itself, but may be used for local development or CI.</p>
<p>I donâ€™t expect you to have a demo project in handy, so <a href="https://github.com/jhandguy/canary-deployment">I built one</a> for you.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git clone https://github.com/jhandguy/canary-deployment.git
</span></span><span style="display:flex;"><span><span style="color:#d0a8ff">cd</span> canary-deployment
</span></span></code></pre></div><p>Alright, let&rsquo;s spin up our Kind cluster! ğŸš€</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ kind create cluster --image kindest/node:v1.27.3 --config=kind/cluster.yaml
</span></span><span style="display:flex;"><span>Creating cluster <span style="color:#fc6a5d">&#34;kind&#34;</span> ...
</span></span><span style="display:flex;"><span> âœ“ Ensuring node image (kindest/node:v1.27.3) ğŸ–¼
</span></span><span style="display:flex;"><span> âœ“ Preparing nodes ğŸ“¦
</span></span><span style="display:flex;"><span> âœ“ Writing configuration ğŸ“œ
</span></span><span style="display:flex;"><span> âœ“ Starting control-plane ğŸ•¹ï¸
</span></span><span style="display:flex;"><span> âœ“ Installing CNI ğŸ”Œ
</span></span><span style="display:flex;"><span> âœ“ Installing StorageClass ğŸ’¾
</span></span><span style="display:flex;"><span>Set kubectl context to <span style="color:#fc6a5d">&#34;kind-kind&#34;</span>
</span></span><span style="display:flex;"><span>You can now use your cluster with:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl cluster-info --context kind-kind
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community ğŸ™‚
</span></span></code></pre></div><h2 id="using-argo-rollouts-with-prometheus">Using Argo Rollouts with Prometheus</h2>
<hr>
<p><a href="https://argoproj.github.io/argo-rollouts/">Argo Rollouts</a> is a <a href="https://kubernetes.io/docs/concepts/architecture/controller/">Kubernetes controller</a> and set of <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">CRDs</a> which provide advanced deployment capabilities to Kubernetes such as blue-green, canary, canary analysis, experimentation, and progressive delivery.</p>
<p>In combination with <a href="https://prometheus.io/">Prometheus</a>, Argo Rollouts can automatically roll back a Canary Deployment based on Prometheus metrics, which means it can theoretically handle an incremental rollout without human intervention.</p>
<h3 id="installing-nginx-ingress-controller">Installing NGINX Ingress Controller</h3>
<hr>
<blockquote>
<p><em>If you havenâ€™t already, go read <a href="/posts/simple-canary-deployment/">Canary Deployment in Kubernetes (Part 1) â€” Simple Canary Deployment using Ingress NGINX</a> and learn how to implement a Simple Canary Deployment using Ingress NGINX!</em></p>
</blockquote>
<p><a href="https://github.com/kubernetes/ingress-nginx">NGINX Ingress Controller</a> is one of the <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/#additional-controllers">many available Kubernetes Ingress Controllers</a>, which acts as a load balancer and satisfies routing rules specified in <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#what-is-ingress">Ingress</a> resources, using the <a href="https://nginx.org/en/">NGINX reverse proxy</a>.</p>
<p>NGINX Ingress Controller can be installed via its <a href="https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx">Helm chart</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
</span></span><span style="display:flex;"><span>helm install ingress-nginx/ingress-nginx --name-template ingress-nginx --create-namespace -n ingress-nginx --values kind/ingress-nginx-values.yaml --version 4.8.3 --wait
</span></span></code></pre></div><p>Now, if everything goes according to plan, you should be able to see the <strong>ingress-nginx-controller</strong> Deployment running.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ kubectl get deploy -n ingress-nginx
</span></span><span style="display:flex;"><span>NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>ingress-nginx-controller   1/1     <span style="color:#d0bf69">1</span>            <span style="color:#d0bf69">1</span>           4m35s
</span></span></code></pre></div><h3 id="installing-argo-rollouts">Installing Argo Rollouts</h3>
<hr>
<blockquote>
<p><em>If you havenâ€™t already, go read <a href="/posts/automated-canary-deployment/">Canary Deployment in Kubernetes (Part 2) â€” Automated Canary Deployment using Argo Rollouts</a> and learn how to implement a Canary Deployment using Argo Rollouts!</em></p>
</blockquote>
<p>Argo Rollouts can be installed via its <a href="https://github.com/argoproj/argo-helm/tree/master/charts/argo-rollouts">Helm chart</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>helm repo add argo https://argoproj.github.io/argo-helm
</span></span><span style="display:flex;"><span>helm install argo/argo-rollouts --name-template argo-rollouts --create-namespace -n argo-rollouts --set dashboard.enabled=<span style="color:#d0a8ff">true</span> --version 2.32.5 --wait
</span></span></code></pre></div><p>If all goes well, you should see two newly spawned Deployments with the READY state.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ kubectl get deploy -n argo-rollouts
</span></span><span style="display:flex;"><span>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>argo-rollouts             1/1     <span style="color:#d0bf69">1</span>            <span style="color:#d0bf69">1</span>           13m
</span></span><span style="display:flex;"><span>argo-rollouts-dashboard   1/1     <span style="color:#d0bf69">1</span>            <span style="color:#d0bf69">1</span>           13m
</span></span></code></pre></div><h3 id="installing-prometheus">Installing Prometheus</h3>
<hr>
<p>Prometheus can be installed via its community <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack">Helm chart</a>, which also provides <a href="https://grafana.com/grafana/">Grafana</a> out of the box.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style="display:flex;"><span>helm install prometheus-community/kube-prometheus-stack --name-template prometheus --create-namespace -n prometheus --version 54.2.2 --wait
</span></span></code></pre></div><p>If everything went fine, you should be able to see three newly spawned deployments with the READY state!</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ kubectl get deploy -n prometheus
</span></span><span style="display:flex;"><span>NAME                                  READY   UP-TO-DATE   AVAILABLE   
</span></span><span style="display:flex;"><span>prometheus-grafana                    1/1     <span style="color:#d0bf69">1</span>            <span style="color:#d0bf69">1</span>           
</span></span><span style="display:flex;"><span>prometheus-kube-prometheus-operator   1/1     <span style="color:#d0bf69">1</span>            <span style="color:#d0bf69">1</span>           
</span></span><span style="display:flex;"><span>prometheus-kube-state-metrics         1/1     <span style="color:#d0bf69">1</span>            <span style="color:#d0bf69">1</span>  
</span></span></code></pre></div><h2 id="automating-rollbacks-using-analysistemplates">Automating Rollbacks using AnalysisTemplates</h2>
<hr>
<p>In <a href="/posts/automated-canary-deployment/">Part 2</a>, we learned how to configure a Rollout and how to automate the Traffic Routing increments via Rollout <code>steps</code>.<br>
Yet another amazing feature of Argo Rollouts is the ability to leverage Prometheus metrics in order to detect faulty deployments (i.e. based on request Success Share or Latency).</p>
<p>To this end, Argo Rollouts provides another <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">Custom Resource</a> called <strong>AnalysisTemplate</strong>.<br>
Alright! Letâ€™s explore what this is!</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>helm install sample-app/helm-charts/argo-rollouts --name-template sample-app --create-namespace -n sample-app --set prometheus.enabled=<span style="color:#d0a8ff">true</span> --wait
</span></span></code></pre></div><p>If everything goes fine, you should eventually see one Rollout with the READY state.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ kubectl get rollout sample-app -n sample-app
</span></span><span style="display:flex;"><span>NAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE
</span></span><span style="display:flex;"><span>sample-app   <span style="color:#d0bf69">1</span>         <span style="color:#d0bf69">1</span>         <span style="color:#d0bf69">1</span>            <span style="color:#d0bf69">1</span>
</span></span></code></pre></div><p>Alright, letâ€™s have a look at the <code>analysistemplate.yaml</code> and the <code>rollout.yaml</code> inside the <code>templates</code> folder!</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ ls -1 sample-app/helm-charts/argo-rollouts/templates
</span></span><span style="display:flex;"><span>analysistemplate.yaml
</span></span><span style="display:flex;"><span>canary
</span></span><span style="display:flex;"><span>ingress.yaml
</span></span><span style="display:flex;"><span>rollout.yaml
</span></span><span style="display:flex;"><span>service.yaml
</span></span><span style="display:flex;"><span>serviceaccount.yaml
</span></span><span style="display:flex;"><span>servicemonitor.yaml
</span></span></code></pre></div><p>An <strong>AnalysisTemplate</strong> is a template <em>spec</em> that defines how to perform a canary analysis. It consists of a Prometheus metric which is being evaluated, at a given interval, against a given success condition.</p>
<p>In this example, the Prometheus metric is a <em>Success Share</em>, with a minimum threshold of 99% and an interval of 1 minute. The failure limit is 0, meaning that as soon as it fails, the Rollout will be aborted. Since it is the canary Deployment that we are trying to evaluate, the PromQL query must target it specifically via the <em>service</em> label.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: argoproj.io/v1alpha1
</span></span><span style="display:flex;"><span>kind: AnalysisTemplate
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  metrics:
</span></span><span style="display:flex;"><span>    - name: success-share
</span></span><span style="display:flex;"><span>      interval: 1m
</span></span><span style="display:flex;"><span>      successCondition: len(result) == 0 || result[0] &gt;= 0.99
</span></span><span style="display:flex;"><span>      failureLimit: <span style="color:#d0bf69">0</span>
</span></span><span style="display:flex;"><span>      provider:
</span></span><span style="display:flex;"><span>        prometheus:
</span></span><span style="display:flex;"><span>          address: {{ .Values.prometheus.address }}
</span></span><span style="display:flex;"><span>          query: |<span style="color:#fc6a5d">
</span></span></span><span style="display:flex;"><span><span style="color:#fc6a5d">            sum(rate(
</span></span></span><span style="display:flex;"><span><span style="color:#fc6a5d">              sample_app_requests_count{service=&#34;{{ .Release.Name }}-canary&#34;, success=&#34;true&#34;}[1m])
</span></span></span><span style="display:flex;"><span><span style="color:#fc6a5d">            ) by (service)
</span></span></span><span style="display:flex;"><span><span style="color:#fc6a5d">            /
</span></span></span><span style="display:flex;"><span><span style="color:#fc6a5d">            sum(rate(
</span></span></span><span style="display:flex;"><span><span style="color:#fc6a5d">              sample_app_requests_count{service=&#34;{{ .Release.Name }}-canary&#34;}[1m])
</span></span></span><span style="display:flex;"><span><span style="color:#fc6a5d">            ) by (service)
</span></span></span><span style="display:flex;"><span><span style="color:#fc6a5d">            unless sum(rate(
</span></span></span><span style="display:flex;"><span><span style="color:#fc6a5d">              sample_app_requests_count{service=&#34;{{ .Release.Name }}-canary&#34;}[1m])
</span></span></span><span style="display:flex;"><span><span style="color:#fc6a5d">            ) by (service) == 0</span>            
</span></span></code></pre></div><p>The instantiation of an <strong>AnalysisTemplate</strong> is called an <strong>AnalysisRun</strong>. It is like a <em>Job</em>, meaning it eventually completes, with a result of either Successful, Failed, or Inconclusive. If successful, the rollout continues, if failed, it is aborted and if inconclusive, it is paused.</p>
<p>There are two ways to define an <strong>AnalysisTemplate</strong>:</p>
<ol>
<li><strong>Background Analysis</strong><br>
This Analysis runs in the background, while the Rollout is progressing through its steps. If the <strong>AnalysisRun</strong> fails, the Rollout is aborted. On the other hand, if the <strong>AnalysisRun</strong> succeeds or all the Rollout steps are finished before it completes, the Rollout is considered successful.</li>
<li><strong>Inline Analysis</strong><br>
This Analysis runs as part of the Rollout steps. This means that the Rollout will wait for the <strong>AnalysisRun</strong> to complete, before proceeding to the next step, or aborting the rollout depending on the outcome.</li>
</ol>
<p>In our case, we will be using the Background Analysis, as it will detect a faulty deployment sooner than an Inline Analysis would.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: argoproj.io/v1alpha1
</span></span><span style="display:flex;"><span>kind: Rollout
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  strategy:
</span></span><span style="display:flex;"><span>    canary:
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>      steps:
</span></span><span style="display:flex;"><span>        - setWeight: <span style="color:#d0bf69">25</span>
</span></span><span style="display:flex;"><span>        - pause: {}
</span></span><span style="display:flex;"><span>        - setWeight: <span style="color:#d0bf69">50</span>
</span></span><span style="display:flex;"><span>        - pause:
</span></span><span style="display:flex;"><span>            duration: 5m
</span></span><span style="display:flex;"><span>        - setWeight: <span style="color:#d0bf69">75</span>
</span></span><span style="display:flex;"><span>        - pause:
</span></span><span style="display:flex;"><span>            duration: 5m
</span></span><span style="display:flex;"><span>      analysis:
</span></span><span style="display:flex;"><span>        templates:
</span></span><span style="display:flex;"><span>          - templateName: {{ .Release.Name }}
</span></span><span style="display:flex;"><span>        startingStep: <span style="color:#d0bf69">2</span>
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>  ...
</span></span></code></pre></div><p>As you can see, the Analysis has been scheduled to start after step 2.<br>
Meaning, once the Rollout is promoted, the <code>canary-weight</code> will be set to 50 and an <strong>AnalysisRun</strong> will start. It will determine later if the Rollout succeeds or not: if the Prometheus metric falls below 99% Success Share, the Rollout will be aborted immediately. On the other hand, if the Success Share stays above 99% for 10 minutes, the Rollout will complete successfully.</p>
<h2 id="detecting-and-aborting-rollouts-automatically">Detecting and Aborting Rollouts Automatically</h2>
<hr>
<p>Now that weâ€™ve seen how an <strong>AnalysisRun</strong> works in theory, letâ€™s see it in practice, shall we?! ğŸ§</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl argo rollouts dashboard -n argo-rollouts &amp;
</span></span></code></pre></div><p>If you now head to <a href="http://localhost:3100/rollout/sample-app">http://localhost:3100/rollout/sample-app</a>, you should see a shiny dashboard showing the state of the <code>sample-app</code> Rollout.</p>
<p><img src="/images/smart-canary-deployment/1.png" alt="Argo Rollouts Dashboard"></p>
<p>Cool! So far, we can observe only one <strong>revision</strong> labeled as <code>stable</code>, serving 100% of the traffic.</p>
<p>Now, letâ€™s set a new image for the container!</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl argo rollouts <span style="color:#d0a8ff">set</span> image sample-app sample-app=ghcr.io/jhandguy/canary-deployment/sample-app:latest -n sample-app
</span></span></code></pre></div><p><img src="/images/smart-canary-deployment/2.png" alt="Argo Rollouts Dashboard"></p>
<p>Tada! The Rollout has just completed step 1: setting the <code>canary-weight</code> to 25%.</p>
<p>As you can see, the <strong>AnalysisRun</strong> has not yet started, this will only happen once we start step 2. Letâ€™s proceed then!</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl argo rollouts promote sample-app -n sample-app
</span></span></code></pre></div><p><img src="/images/smart-canary-deployment/3.png" alt="Argo Rollouts Dashboard"></p>
<p>Awesome! The <code>canary-weight</code> is now at 50% and an <strong>AnalysisRun</strong> has just started.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ kubectl get analysisrun -n sample-app
</span></span><span style="display:flex;"><span>NAME                      STATUS
</span></span><span style="display:flex;"><span>sample-app-5c9fc8b7d4-2   Running
</span></span></code></pre></div><p>Letâ€™s have a deeper look at it!</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ kubectl describe analysisrun -n sample-app
</span></span><span style="display:flex;"><span>Name:         sample-app-5c9fc8b7d4-2
</span></span><span style="display:flex;"><span>Namespace:    sample-app
</span></span><span style="display:flex;"><span>Labels:       rollout-type=Background
</span></span><span style="display:flex;"><span>              rollouts-pod-template-hash=5c9fc8b7d4
</span></span><span style="display:flex;"><span>Annotations:  rollout.argoproj.io/revision: <span style="color:#d0bf69">2</span>
</span></span><span style="display:flex;"><span>API Version:  argoproj.io/v1alpha1
</span></span><span style="display:flex;"><span>Kind:         AnalysisRun
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Spec:
</span></span><span style="display:flex;"><span>  Metrics:
</span></span><span style="display:flex;"><span>    Failure Limit:  <span style="color:#d0bf69">0</span>
</span></span><span style="display:flex;"><span>    Interval:       1m
</span></span><span style="display:flex;"><span>    Name:           success-share
</span></span><span style="display:flex;"><span>    Provider:
</span></span><span style="display:flex;"><span>      Prometheus:
</span></span><span style="display:flex;"><span>        Address:  http://prometheus-operated.prometheus.svc.cluster.local:9090
</span></span><span style="display:flex;"><span>        Query:    sum(rate(
</span></span><span style="display:flex;"><span>                    sample_app_requests_count{<span style="color:#41a1c0">service</span>=<span style="color:#fc6a5d">&#34;sample-app-canary&#34;</span>, <span style="color:#41a1c0">success</span>=<span style="color:#fc6a5d">&#34;true&#34;</span>}[1m])
</span></span><span style="display:flex;"><span>                  ) by (service)
</span></span><span style="display:flex;"><span>                  /
</span></span><span style="display:flex;"><span>                  sum(rate(
</span></span><span style="display:flex;"><span>                    sample_app_requests_count{<span style="color:#41a1c0">service</span>=<span style="color:#fc6a5d">&#34;sample-app-canary&#34;</span>}[1m])
</span></span><span style="display:flex;"><span>                  ) by (service)
</span></span><span style="display:flex;"><span>                  unless sum(rate(
</span></span><span style="display:flex;"><span>                    sample_app_requests_count{<span style="color:#41a1c0">service</span>=<span style="color:#fc6a5d">&#34;sample-app-canary&#34;</span>}[1m])
</span></span><span style="display:flex;"><span>                  ) by (service) == <span style="color:#d0bf69">0</span>
</span></span><span style="display:flex;"><span>    Success Condition:  len(result) == <span style="color:#d0bf69">0</span> || result[0] &gt;= 0.99
</span></span><span style="display:flex;"><span>Status:
</span></span><span style="display:flex;"><span>  Metric Results:
</span></span><span style="display:flex;"><span>    Count:  <span style="color:#d0bf69">1</span>
</span></span><span style="display:flex;"><span>    Measurements:
</span></span><span style="display:flex;"><span>      Finished At:  2022-01-29T18:37:49Z
</span></span><span style="display:flex;"><span>      Phase:        Successful
</span></span><span style="display:flex;"><span>      Started At:   2022-01-29T18:37:49Z
</span></span><span style="display:flex;"><span>      Value:        []
</span></span><span style="display:flex;"><span>    Name:           success-share
</span></span><span style="display:flex;"><span>    Phase:          Running
</span></span><span style="display:flex;"><span>    Successful:     <span style="color:#d0bf69">1</span>
</span></span><span style="display:flex;"><span>  Phase:            Running
</span></span><span style="display:flex;"><span>  Started At:       2022-01-29T18:37:49Z
</span></span><span style="display:flex;"><span>Events:             &lt;none&gt;
</span></span></code></pre></div><p>As expected, the Spec part of the <strong>AnalysisRun</strong> is the same one weâ€™ve specified in the <strong>AnalysisTemplate</strong>.<br>
To monitor the progress of the Rollout, however, it is the <em>Status</em> and the <em>Events</em> that we will be looking at.</p>
<p>Right now, the measurementâ€™s value is empty (<code>[]</code>), this is because the service has not recorded any metrics yet. Letâ€™s change that and send some successful requests for Prometheus to scrape! ğŸš€</p>
<blockquote>
<p>Since the PromQL query targets the canary Service specifically, we must make sure to always land in the canary Deployment using the Ingress <code>canary-by-header</code> annotation (learn more about it in <a href="/posts/simple-canary-deployment/">Part 1</a>).</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl localhost/success -H <span style="color:#fc6a5d">&#34;Host: sample.app&#34;</span> -H <span style="color:#fc6a5d">&#34;X-Canary: always&#34;</span>
</span></span></code></pre></div><p>After firing some requests and waiting about a minute for Prometheus to scrape the metrics and the <strong>AnalysisRun</strong> to measure the <code>success-share</code> metric, you should see one of the measurements with a value of <code>[1]</code>, meaning that the Success Share has been successfully measured at 100%! ğŸ’¯</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ kubectl describe analysisrun -n sample-app
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Status:
</span></span><span style="display:flex;"><span>  Metric Results:
</span></span><span style="display:flex;"><span>    Count:  <span style="color:#d0bf69">5</span>
</span></span><span style="display:flex;"><span>    Measurements:
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>      Finished At:  2022-01-29T18:41:49Z
</span></span><span style="display:flex;"><span>      Phase:        Successful
</span></span><span style="display:flex;"><span>      Started At:   2022-01-29T18:41:49Z
</span></span><span style="display:flex;"><span>      Value:        [1]
</span></span><span style="display:flex;"><span>    Name:           success-share
</span></span><span style="display:flex;"><span>    Phase:          Running
</span></span><span style="display:flex;"><span>    Successful:     <span style="color:#d0bf69">5</span>
</span></span><span style="display:flex;"><span>  Phase:            Running
</span></span><span style="display:flex;"><span>  Started At:       2022-01-29T18:37:49Z
</span></span><span style="display:flex;"><span>Events:             &lt;none&gt;
</span></span></code></pre></div><p>The best part of this is, that while all of this was happening, the Rollout kept on progressing and has probably already reached the next step: increasing the <code>canary-weight</code> to 75%.</p>
<p><img src="/images/smart-canary-deployment/4.png" alt="Argo Rollouts Dashboard"></p>
<p>Thatâ€™s great! But letâ€™s make things more interesting: what happens once the Success Share falls below 99%? ğŸ˜±</p>
<p>Letâ€™s go ahead and simulate a 50% Success Share by sending several requests and alternating between successes and errors!</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl localhost/success -H <span style="color:#fc6a5d">&#34;Host: sample.app&#34;</span> -H <span style="color:#fc6a5d">&#34;X-Canary: always&#34;</span>
</span></span><span style="display:flex;"><span>curl localhost/error -H <span style="color:#fc6a5d">&#34;Host: sample.app&#34;</span> -H <span style="color:#fc6a5d">&#34;X-Canary: always&#34;</span>
</span></span></code></pre></div><p>After a short while, you should notice that something quite magical has happenedâ€¦ ğŸª„</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ kubectl describe analysisrun -n sample-app
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Status:
</span></span><span style="display:flex;"><span>  Message:  metric <span style="color:#fc6a5d">&#34;success-share&#34;</span> assessed Failed due to failed (1) &gt; failureLimit (0)
</span></span><span style="display:flex;"><span>  Metric Results:
</span></span><span style="display:flex;"><span>    Count:   <span style="color:#d0bf69">9</span>
</span></span><span style="display:flex;"><span>    Failed:  <span style="color:#d0bf69">1</span>
</span></span><span style="display:flex;"><span>    Measurements:
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>      Finished At:  2022-01-29T18:45:49Z
</span></span><span style="display:flex;"><span>      Phase:        Failed
</span></span><span style="display:flex;"><span>      Started At:   2022-01-29T18:45:49Z
</span></span><span style="display:flex;"><span>      Value:        [0.5]
</span></span><span style="display:flex;"><span>    Name:           success-share
</span></span><span style="display:flex;"><span>    Phase:          Failed
</span></span><span style="display:flex;"><span>    Successful:     <span style="color:#d0bf69">8</span>
</span></span><span style="display:flex;"><span>  Phase:            Failed
</span></span><span style="display:flex;"><span>  Started At:       2022-01-29T18:37:49Z
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type     Reason             Age   From                 Message
</span></span><span style="display:flex;"><span>  ----     ------             ----  ----                 -------
</span></span><span style="display:flex;"><span>  Warning  MetricFailed       17s   rollouts-controller  metric <span style="color:#fc6a5d">&#39;success-share&#39;</span> completed Failed
</span></span><span style="display:flex;"><span>  Warning  AnalysisRunFailed  17s   rollouts-controller  analysis completed Failed
</span></span></code></pre></div><p>As soon as the <strong>AnalysisRun</strong> recorded a measurement breaching below the 99% Success Share threshold, the Rollout was immediately aborted.</p>
<p>Letâ€™s confirm that from the Rolloutâ€™s status real quick!</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ kubectl argo rollouts status sample-app -n sample-app
</span></span><span style="display:flex;"><span>Degraded
</span></span><span style="display:flex;"><span>Error: The rollout is in a degraded state with message: RolloutAborted: Rollout aborted update to revision 2: metric <span style="color:#fc6a5d">&#34;success-share&#34;</span> assessed Failed due to failed (1) &gt; failureLimit (0)
</span></span></code></pre></div><p>Indeed, even the Dashboard highlights that the Rollout is in a <em>Degraded</em> state, and consequently the <code>canary-weight</code> has been taken down to 0%.</p>
<p><img src="/images/smart-canary-deployment/5.png" alt="Argo Rollouts Dashboard"></p>
<p>This would, in practice, give us time to investigate the issue, and once fixed, <strong>retry</strong> the Rollout, either via the CLI or the Dashboardâ€™s <em>RETRY</em> button.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl argo rollouts retry rollout sample-app -n sample-app
</span></span><span style="display:flex;"><span>kubectl argo rollouts promote sample-app -n sample-app
</span></span></code></pre></div><p>Now that the Rollout has restarted and reached step 2, a new <strong>AnalysisRun</strong> has started and the incremental rollout is back on track! ğŸ›¤</p>
<p><img src="/images/smart-canary-deployment/6.png" alt="Argo Rollouts Dashboard"></p>
<h3 id="load-testing-with-k6">Load Testing with k6</h3>
<hr>
<p>Instead of running some <code>curl</code> commands like we previously did, how about we execute a Load Test instead?</p>
<p>For Load Testing, I really recommend <a href="https://k6.io/docs/">k6</a> from the Grafana Labs team. It is a dead-simple yet super powerful tool with very extensive documentation.</p>
<p>See for yourself!</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>k6 run k6/script.js
</span></span></code></pre></div><p>After about 1 minute, k6 should be done executing the load test and show you the results.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>          /<span style="color:#fc6a5d">\ </span>     |â€¾â€¾| /â€¾â€¾/   /â€¾â€¾/
</span></span><span style="display:flex;"><span>     /<span style="color:#fc6a5d">\ </span> /  <span style="color:#fc6a5d">\ </span>    |  |/  /   /  /
</span></span><span style="display:flex;"><span>    /  <span style="color:#fc6a5d">\/</span>    <span style="color:#fc6a5d">\ </span>   |     (   /   â€¾â€¾<span style="color:#fc6a5d">\
</span></span></span><span style="display:flex;"><span><span style="color:#fc6a5d"></span>   /          <span style="color:#fc6a5d">\ </span>  |  |<span style="color:#fc6a5d">\ </span> <span style="color:#fc6a5d">\ </span>|  (â€¾)  |
</span></span><span style="display:flex;"><span>  / __________ <span style="color:#fc6a5d">\ </span> |__| <span style="color:#fc6a5d">\_</span>_<span style="color:#fc6a5d">\ \_</span>____/ .io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  execution: <span style="color:#d0a8ff">local</span>
</span></span><span style="display:flex;"><span>     script: k6/script.js
</span></span><span style="display:flex;"><span>     output: -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  scenarios: (100.00%) <span style="color:#d0bf69">1</span> scenario, <span style="color:#d0bf69">20</span> max VUs, 1m30s max duration (incl. graceful stop):
</span></span><span style="display:flex;"><span>           * load: Up to 20.00 iterations/s <span style="color:#fc5fa3">for</span> 1m0s over <span style="color:#d0bf69">2</span> stages (maxVUs: 20, gracefulStop: 30s)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     âœ“ status code is <span style="color:#d0bf69">200</span>
</span></span><span style="display:flex;"><span>     âœ“ node is kind-control-plane
</span></span><span style="display:flex;"><span>     âœ“ namespace is sample-app
</span></span><span style="display:flex;"><span>     âœ“ pod is sample-app-*
</span></span><span style="display:flex;"><span>     âœ“ deployment is stable or canary
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   âœ“ checks.........................: 100.00% âœ“ <span style="color:#d0bf69">3095</span>      âœ— <span style="color:#d0bf69">0</span>
</span></span><span style="display:flex;"><span>     data_received..................: <span style="color:#d0bf69">157</span> kB  2.6 kB/s
</span></span><span style="display:flex;"><span>     data_sent......................: <span style="color:#d0bf69">71</span> kB   1.2 kB/s
</span></span><span style="display:flex;"><span>     http_req_blocked...............: <span style="color:#41a1c0">avg</span>=41.24Âµs <span style="color:#41a1c0">min</span>=3Âµs    <span style="color:#41a1c0">med</span>=8Âµs    <span style="color:#41a1c0">max</span>=3.39ms  p(90)=19Âµs   p(95)=55.19Âµs
</span></span><span style="display:flex;"><span>     http_req_connecting............: <span style="color:#41a1c0">avg</span>=21.96Âµs <span style="color:#41a1c0">min</span>=0s     <span style="color:#41a1c0">med</span>=0s     <span style="color:#41a1c0">max</span>=2.71ms  p(90)=0s     p(95)=0s
</span></span><span style="display:flex;"><span>   âœ“ http_req_duration..............: <span style="color:#41a1c0">avg</span>=3.75ms  <span style="color:#41a1c0">min</span>=940Âµs  <span style="color:#41a1c0">med</span>=2.96ms <span style="color:#41a1c0">max</span>=17.22ms p(90)=6.99ms p(95)=9.37ms
</span></span><span style="display:flex;"><span>       { expected_response:true }...: <span style="color:#41a1c0">avg</span>=3.75ms  <span style="color:#41a1c0">min</span>=940Âµs  <span style="color:#41a1c0">med</span>=2.96ms <span style="color:#41a1c0">max</span>=17.22ms p(90)=6.99ms p(95)=9.37ms
</span></span><span style="display:flex;"><span>     http_req_failed................: 0.00%   âœ“ <span style="color:#d0bf69">0</span>         âœ— <span style="color:#d0bf69">619</span>
</span></span><span style="display:flex;"><span>     http_req_rate..................: 50.00%  âœ“ <span style="color:#d0bf69">619</span>       âœ— <span style="color:#d0bf69">619</span>
</span></span><span style="display:flex;"><span>     âœ“ { deployment:canary }........: 49.91%  âœ“ <span style="color:#d0bf69">309</span>       âœ— <span style="color:#d0bf69">310</span>
</span></span><span style="display:flex;"><span>     âœ“ { deployment:stable }........: 50.08%  âœ“ <span style="color:#d0bf69">310</span>       âœ— <span style="color:#d0bf69">309</span>
</span></span><span style="display:flex;"><span>     http_req_receiving.............: <span style="color:#41a1c0">avg</span>=107.1Âµs <span style="color:#41a1c0">min</span>=24Âµs   <span style="color:#41a1c0">med</span>=88Âµs   <span style="color:#41a1c0">max</span>=2.09ms  p(90)=165Âµs  p(95)=189.09Âµs
</span></span><span style="display:flex;"><span>     http_req_sending...............: <span style="color:#41a1c0">avg</span>=50.78Âµs <span style="color:#41a1c0">min</span>=14Âµs   <span style="color:#41a1c0">med</span>=36Âµs   <span style="color:#41a1c0">max</span>=837Âµs   p(90)=77Âµs   p(95)=114.19Âµs
</span></span><span style="display:flex;"><span>     http_req_tls_handshaking.......: <span style="color:#41a1c0">avg</span>=0s      <span style="color:#41a1c0">min</span>=0s     <span style="color:#41a1c0">med</span>=0s     <span style="color:#41a1c0">max</span>=0s      p(90)=0s     p(95)=0s
</span></span><span style="display:flex;"><span>     http_req_waiting...............: <span style="color:#41a1c0">avg</span>=3.6ms   <span style="color:#41a1c0">min</span>=857Âµs  <span style="color:#41a1c0">med</span>=2.78ms <span style="color:#41a1c0">max</span>=17.09ms p(90)=6.81ms p(95)=9.1ms
</span></span><span style="display:flex;"><span>     http_reqs......................: <span style="color:#d0bf69">619</span>     10.316653/s
</span></span><span style="display:flex;"><span>     iteration_duration.............: <span style="color:#41a1c0">avg</span>=4.31ms  <span style="color:#41a1c0">min</span>=1.09ms <span style="color:#41a1c0">med</span>=3.53ms <span style="color:#41a1c0">max</span>=21.84ms p(90)=7.82ms p(95)=10.34ms
</span></span><span style="display:flex;"><span>     iterations.....................: <span style="color:#d0bf69">619</span>     10.316653/s
</span></span><span style="display:flex;"><span>     vus............................: <span style="color:#d0bf69">0</span>       <span style="color:#41a1c0">min</span>=<span style="color:#d0bf69">0</span>       <span style="color:#41a1c0">max</span>=<span style="color:#d0bf69">0</span>
</span></span><span style="display:flex;"><span>     vus_max........................: <span style="color:#d0bf69">20</span>      <span style="color:#41a1c0">min</span>=<span style="color:#d0bf69">20</span>      <span style="color:#41a1c0">max</span>=<span style="color:#d0bf69">20</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>running (1m00.0s), 00/20 VUs, <span style="color:#d0bf69">619</span> <span style="color:#d0a8ff">complete</span> and <span style="color:#d0bf69">0</span> interrupted iterations
</span></span><span style="display:flex;"><span>load âœ“ [======================================] 00/20 VUs  1m0s  00.71 iters/s
</span></span></code></pre></div><p>That sounds about right!<br>
Depending on which step the Rollout is at, the Traffic Distribution shown in k6â€™s output should be either 50/50 or 75/25.</p>
<p>Same as before, if you now describe the <strong>AnalysisRun</strong>, you should see some successful measurements were measured.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ kubectl describe analysisrun -n sample-app
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Status:
</span></span><span style="display:flex;"><span>  Metric Results:
</span></span><span style="display:flex;"><span>    Count:  <span style="color:#d0bf69">5</span>
</span></span><span style="display:flex;"><span>    Measurements:
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>      Phase:        Successful
</span></span><span style="display:flex;"><span>      Started At:   2022-01-30T14:34:07Z
</span></span><span style="display:flex;"><span>      Value:        [1]
</span></span><span style="display:flex;"><span>    Name:           success-share
</span></span><span style="display:flex;"><span>    Phase:          Running
</span></span><span style="display:flex;"><span>    Successful:     <span style="color:#d0bf69">5</span>
</span></span><span style="display:flex;"><span>  Phase:            Running
</span></span><span style="display:flex;"><span>  Started At:       2022-01-30T14:32:07Z
</span></span><span style="display:flex;"><span>Events:             &lt;none&gt;
</span></span></code></pre></div><p>Eventually, the Rollout should complete successfully and the new revision should become the new <code>stable</code> Deployment! ğŸ‰</p>
<p><img src="/images/smart-canary-deployment/7.png" alt="Argo Rollouts Dashboard"></p>
<h2 id="wrapping-up">Wrapping up</h2>
<hr>
<p>Thatâ€™s it! You can now delete your Kind cluster!</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kind delete cluster
</span></span></code></pre></div><p>To summarize, using Argo Rollouts and Prometheus we were able to:</p>
<ul>
<li>Detect when a Prometheus metric breaches a given threshold and abort the faulty Rollout automatically, thanks to the <strong>AnalysisRun</strong> CRD;</li>
<li>Restart the aborted Rollout effortlessly once the issue is fixed.</li>
</ul>
<p>Was it worth it? Did that help you understand how to implement Canary Deployment in Kubernetes using Argo Rollouts and Prometheus?</p>
<p>If so, follow me on <a href="https://twitter.com/jhandguy">Twitter</a>, Iâ€™ll be happy to answer any of your questions and youâ€™ll be the first one to know when a new article comes out! ğŸ‘Œ</p>
<p>Bye-bye! ğŸ‘‹</p>

        </div>
    </div>
</section>

</body>
<footer>
    <div class="footer pt-3 has-background-black-bis">
        <div class="container pb-6 has-text-centered is-mobile columns">
            <div class="column is-narrow paddingless">
                
                
                <a class="button is-large" href="https://jhandguy.github.io/posts/automated-canary-deployment/"><strong>ğŸ‘ˆ</strong></a>
                
                
            </div>
            <div class="column"></div>
            <div class="column is-narrow paddingless">
                <a class="button is-large" href="#"><strong>ğŸ‘†</strong></a>
            </div>
            <div class="column"></div>
            <div class="column is-narrow paddingless">
                
                
                <a class="button is-large" href="https://jhandguy.github.io/posts/incremental-mobile-force-update/"><strong>ğŸ‘‰</strong></a>
                
                
            </div>
        </div>
        <div class="content has-text-centered">
            <p class="subtitle is-6">Powered by <a href="https://gohugo.io/">Hugo</a></p>
            <a href="https://bulma.io">
                <img src="/images/footer/made-with-bulma.png" alt="Made with Bulma" width="128" height="24">
            </a>
        </div>
    </div>
</footer>

</html>
