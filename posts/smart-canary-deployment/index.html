<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Canary Deployment in Kubernetes (Part 3) ‚Äî Smart Canary Deployment using Argo Rollouts and Prometheus</title>
    <link rel="stylesheet" href="/css/bulma.min.css">
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="stylesheet" href="/css/hugo.css">
</head>

<body>
<nav class="navbar">
    <div class="navbar-brand">
        <a class="navbar-item" href="/">
            Home
        </a>

        <div class="navbar-item">
            <a class="button is-link" href="/about">
                <strong>About me</strong>
            </a>
        </div>
    </div>
</nav>

<section class="section">
    <div class="container is-max-desktop">
        <div class="content">
            <p class="title is-spaced">Canary Deployment in Kubernetes (Part 3) ‚Äî Smart Canary Deployment using Argo Rollouts and Prometheus</p>
            
            
            <div class="box">
                <p class="subtitle">Table of Contents</p>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#creating-kind-cluster">Creating Kind Cluster</a></li>
    <li><a href="#using-argo-rollouts-with-prometheus">Using Argo Rollouts with Prometheus</a>
      <ul>
        <li><a href="#installing-nginx-ingress-controller">Installing NGINX Ingress Controller</a></li>
        <li><a href="#installing-argo-rollouts">Installing Argo Rollouts</a></li>
        <li><a href="#installing-prometheus">Installing Prometheus</a></li>
      </ul>
    </li>
    <li><a href="#automating-rollbacks-using-analysistemplates">Automating Rollbacks using AnalysisTemplates</a></li>
    <li><a href="#detecting-and-aborting-rollouts-automatically">Detecting and Aborting Rollouts Automatically</a>
      <ul>
        <li><a href="#load-testing-with-k6">Load Testing with k6</a></li>
      </ul>
    </li>
    <li><a href="#wrapping-up">Wrapping up</a></li>
  </ul>
</nav>
            </div>
            
            
        </div>
    </div>
    <div class="container is-max-desktop mt-6">
        <div class="content has-text-justified-tablet">
            <p>Deploying to production in Kubernetes can be quite stressful. Even after meaningful and reliable automated tests have successfully passed, there is still room for things to go wrong and lead to a nasty incident when pressing the final button.</p>
<p>Thankfully, Kubernetes is made to be resilient to this kind of scenario, and rolling back is a no-brainer. But still, rolling back means that, at least for some time, <strong>all of the users</strong> were negatively impacted by the faulty change‚Ä¶</p>
<p>What if we could smoke test our change in production <strong>before</strong> it actually hits real users? What if we could roll out a change incrementally to <strong>some users</strong> instead of all of them at once? What if we could detect a faulty deployment and roll it back automatically?<br>
Well, that, my friend, is what Canary Deployment is all about!</p>
<blockquote>
<p>Minimizing the impact on real users while deploying a risky change to production.</p>
</blockquote>
<p>üé¨ Hi there, I‚Äôm Jean!</p>
<p>In this 3 parts series, we‚Äôre going to explore several ways to do Canary Deployment in Kubernetes, and the first one is‚Ä¶<br>
ü•Å<br>
‚Ä¶ using <strong>Argo Rollouts and Prometheus</strong>! üéä</p>
<h2 id="requirements">Requirements</h2>
<hr>
<p>Before we start, make sure you have the following tools installed:</p>
<ul>
<li><a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation">Kind</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/">Kubectl</a></li>
<li><a href="https://argoproj.github.io/argo-rollouts/installation/#kubectl-plugin-installation">Argo Rollouts Kubectl Plugin</a></li>
<li><a href="https://helm.sh/docs/intro/install/">Helm</a></li>
<li><a href="https://k6.io/docs/getting-started/installation/">K6</a></li>
</ul>
<blockquote>
<p><em>Note: for MacOS users or Linux users using Homebrew, simply run:</em><br>
<code>brew install kind kubectl argoproj/tap/kubectl-argo-rollouts helm k6</code></p>
</blockquote>
<p>All set? Let‚Äôs go! üèÅ</p>
<h2 id="creating-kind-cluster">Creating Kind Cluster</h2>
<hr>
<p><a href="https://kind.sigs.k8s.io/">Kind</a> is a tool for running local Kubernetes clusters using Docker container ‚Äúnodes‚Äù.
It was primarily designed for testing Kubernetes itself, but may be used for local development or CI.</p>
<p>I don‚Äôt expect you to have a demo project in handy, so <a href="https://github.com/jhandguy/canary-deployment">I built one</a> for you.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git clone https://github.com/jhandguy/canary-deployment.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> canary-deployment
</span></span></code></pre></div><p>Alright, let&rsquo;s spin up our Kind cluster! üöÄ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kind create cluster --image kindest/node:v1.27.3 --config<span class="o">=</span>kind/cluster.yaml
</span></span><span class="line"><span class="cl">Creating cluster <span class="s2">&#34;kind&#34;</span> ...
</span></span><span class="line"><span class="cl"> ‚úì Ensuring node image <span class="o">(</span>kindest/node:v1.27.3<span class="o">)</span> üñº
</span></span><span class="line"><span class="cl"> ‚úì Preparing nodes üì¶
</span></span><span class="line"><span class="cl"> ‚úì Writing configuration üìú
</span></span><span class="line"><span class="cl"> ‚úì Starting control-plane üïπÔ∏è
</span></span><span class="line"><span class="cl"> ‚úì Installing CNI üîå
</span></span><span class="line"><span class="cl"> ‚úì Installing StorageClass üíæ
</span></span><span class="line"><span class="cl">Set kubectl context to <span class="s2">&#34;kind-kind&#34;</span>
</span></span><span class="line"><span class="cl">You can now use your cluster with:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl cluster-info --context kind-kind
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community üôÇ
</span></span></code></pre></div><h2 id="using-argo-rollouts-with-prometheus">Using Argo Rollouts with Prometheus</h2>
<hr>
<p><a href="https://argoproj.github.io/argo-rollouts/">Argo Rollouts</a> is a <a href="https://kubernetes.io/docs/concepts/architecture/controller/">Kubernetes controller</a> and set of <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">CRDs</a> which provide advanced deployment capabilities to Kubernetes such as blue-green, canary, canary analysis, experimentation, and progressive delivery.</p>
<p>In combination with <a href="https://prometheus.io/">Prometheus</a>, Argo Rollouts can automatically roll back a Canary Deployment based on Prometheus metrics, which means it can theoretically handle an incremental rollout without human intervention.</p>
<h3 id="installing-nginx-ingress-controller">Installing NGINX Ingress Controller</h3>
<hr>
<blockquote>
<p><em>If you haven‚Äôt already, go read <a href="/posts/simple-canary-deployment/">Canary Deployment in Kubernetes (Part 1) ‚Äî Simple Canary Deployment using Ingress NGINX</a> and learn how to implement a Simple Canary Deployment using Ingress NGINX!</em></p>
</blockquote>
<p><a href="https://github.com/kubernetes/ingress-nginx">NGINX Ingress Controller</a> is one of the <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/#additional-controllers">many available Kubernetes Ingress Controllers</a>, which acts as a load balancer and satisfies routing rules specified in <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#what-is-ingress">Ingress</a> resources, using the <a href="https://nginx.org/en/">NGINX reverse proxy</a>.</p>
<p>NGINX Ingress Controller can be installed via its <a href="https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx">Helm chart</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
</span></span><span class="line"><span class="cl">helm install ingress-nginx/ingress-nginx --name-template ingress-nginx --create-namespace -n ingress-nginx --values kind/ingress-nginx-values.yaml --version 4.8.3 --wait
</span></span></code></pre></div><p>Now, if everything goes according to plan, you should be able to see the <strong>ingress-nginx-controller</strong> Deployment running.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl get deploy -n ingress-nginx
</span></span><span class="line"><span class="cl">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">ingress-nginx-controller   1/1     <span class="m">1</span>            <span class="m">1</span>           4m35s
</span></span></code></pre></div><h3 id="installing-argo-rollouts">Installing Argo Rollouts</h3>
<hr>
<blockquote>
<p><em>If you haven‚Äôt already, go read <a href="/posts/automated-canary-deployment/">Canary Deployment in Kubernetes (Part 2) ‚Äî Automated Canary Deployment using Argo Rollouts</a> and learn how to implement a Canary Deployment using Argo Rollouts!</em></p>
</blockquote>
<p>Argo Rollouts can be installed via its <a href="https://github.com/argoproj/argo-helm/tree/master/charts/argo-rollouts">Helm chart</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm repo add argo https://argoproj.github.io/argo-helm
</span></span><span class="line"><span class="cl">helm install argo/argo-rollouts --name-template argo-rollouts --create-namespace -n argo-rollouts --set dashboard.enabled<span class="o">=</span><span class="nb">true</span> --version 2.32.5 --wait
</span></span></code></pre></div><p>If all goes well, you should see two newly spawned Deployments with the READY state.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl get deploy -n argo-rollouts
</span></span><span class="line"><span class="cl">NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">argo-rollouts             1/1     <span class="m">1</span>            <span class="m">1</span>           13m
</span></span><span class="line"><span class="cl">argo-rollouts-dashboard   1/1     <span class="m">1</span>            <span class="m">1</span>           13m
</span></span></code></pre></div><h3 id="installing-prometheus">Installing Prometheus</h3>
<hr>
<p>Prometheus can be installed via its community <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack">Helm chart</a>, which also provides <a href="https://grafana.com/grafana/">Grafana</a> out of the box.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span class="line"><span class="cl">helm install prometheus-community/kube-prometheus-stack --name-template prometheus --create-namespace -n prometheus --version 54.2.2 --wait
</span></span></code></pre></div><p>If everything went fine, you should be able to see three newly spawned deployments with the READY state!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl get deploy -n prometheus
</span></span><span class="line"><span class="cl">NAME                                  READY   UP-TO-DATE   AVAILABLE   
</span></span><span class="line"><span class="cl">prometheus-grafana                    1/1     <span class="m">1</span>            <span class="m">1</span>           
</span></span><span class="line"><span class="cl">prometheus-kube-prometheus-operator   1/1     <span class="m">1</span>            <span class="m">1</span>           
</span></span><span class="line"><span class="cl">prometheus-kube-state-metrics         1/1     <span class="m">1</span>            <span class="m">1</span>  
</span></span></code></pre></div><h2 id="automating-rollbacks-using-analysistemplates">Automating Rollbacks using AnalysisTemplates</h2>
<hr>
<p>In <a href="/posts/automated-canary-deployment/">Part 2</a>, we learned how to configure a Rollout and how to automate the Traffic Routing increments via Rollout <code>steps</code>.<br>
Yet another amazing feature of Argo Rollouts is the ability to leverage Prometheus metrics in order to detect faulty deployments (i.e. based on request Success Share or Latency).</p>
<p>To this end, Argo Rollouts provides another <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">Custom Resource</a> called <strong>AnalysisTemplate</strong>.<br>
Alright! Let‚Äôs explore what this is!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm install sample-app/helm-charts/argo-rollouts --name-template sample-app --create-namespace -n sample-app --set prometheus.enabled<span class="o">=</span><span class="nb">true</span> --wait
</span></span></code></pre></div><p>If everything goes fine, you should eventually see one Rollout with the READY state.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl get rollout sample-app -n sample-app
</span></span><span class="line"><span class="cl">NAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE
</span></span><span class="line"><span class="cl">sample-app   <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>            <span class="m">1</span>
</span></span></code></pre></div><p>Alright, let‚Äôs have a look at the <code>analysistemplate.yaml</code> and the <code>rollout.yaml</code> inside the <code>templates</code> folder!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú ls -1 sample-app/helm-charts/argo-rollouts/templates
</span></span><span class="line"><span class="cl">analysistemplate.yaml
</span></span><span class="line"><span class="cl">canary
</span></span><span class="line"><span class="cl">ingress.yaml
</span></span><span class="line"><span class="cl">rollout.yaml
</span></span><span class="line"><span class="cl">service.yaml
</span></span><span class="line"><span class="cl">serviceaccount.yaml
</span></span><span class="line"><span class="cl">servicemonitor.yaml
</span></span></code></pre></div><p>An <strong>AnalysisTemplate</strong> is a template <em>spec</em> that defines how to perform a canary analysis. It consists of a Prometheus metric which is being evaluated, at a given interval, against a given success condition.</p>
<p>In this example, the Prometheus metric is a <em>Success Share</em>, with a minimum threshold of 99% and an interval of 1 minute. The failure limit is 0, meaning that as soon as it fails, the Rollout will be aborted. Since it is the canary Deployment that we are trying to evaluate, the PromQL query must target it specifically via the <em>service</em> label.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AnalysisTemplate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">success-share</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">successCondition</span><span class="p">:</span><span class="w"> </span><span class="l">len(result) == 0 || result[0] &gt;= 0.99</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">failureLimit</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.prometheus.address }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            sum(rate(
</span></span></span><span class="line"><span class="cl"><span class="sd">              sample_app_requests_count{service=&#34;{{ .Release.Name }}-canary&#34;, success=&#34;true&#34;}[1m])
</span></span></span><span class="line"><span class="cl"><span class="sd">            ) by (service)
</span></span></span><span class="line"><span class="cl"><span class="sd">            /
</span></span></span><span class="line"><span class="cl"><span class="sd">            sum(rate(
</span></span></span><span class="line"><span class="cl"><span class="sd">              sample_app_requests_count{service=&#34;{{ .Release.Name }}-canary&#34;}[1m])
</span></span></span><span class="line"><span class="cl"><span class="sd">            ) by (service)
</span></span></span><span class="line"><span class="cl"><span class="sd">            unless sum(rate(
</span></span></span><span class="line"><span class="cl"><span class="sd">              sample_app_requests_count{service=&#34;{{ .Release.Name }}-canary&#34;}[1m])
</span></span></span><span class="line"><span class="cl"><span class="sd">            ) by (service) == 0</span><span class="w">            
</span></span></span></code></pre></div><p>The instantiation of an <strong>AnalysisTemplate</strong> is called an <strong>AnalysisRun</strong>. It is like a <em>Job</em>, meaning it eventually completes, with a result of either Successful, Failed, or Inconclusive. If successful, the rollout continues, if failed, it is aborted and if inconclusive, it is paused.</p>
<p>There are two ways to define an <strong>AnalysisTemplate</strong>:</p>
<ol>
<li><strong>Background Analysis</strong><br>
This Analysis runs in the background, while the Rollout is progressing through its steps. If the <strong>AnalysisRun</strong> fails, the Rollout is aborted. On the other hand, if the <strong>AnalysisRun</strong> succeeds or all the Rollout steps are finished before it completes, the Rollout is considered successful.</li>
<li><strong>Inline Analysis</strong><br>
This Analysis runs as part of the Rollout steps. This means that the Rollout will wait for the <strong>AnalysisRun</strong> to complete, before proceeding to the next step, or aborting the rollout depending on the outcome.</li>
</ol>
<p>In our case, we will be using the Background Analysis, as it will detect a faulty deployment sooner than an Inline Analysis would.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rollout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">canary</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">75</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">templates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">templateName</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">startingStep</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span></code></pre></div><p>As you can see, the Analysis has been scheduled to start after step 2.<br>
Meaning, once the Rollout is promoted, the <code>canary-weight</code> will be set to 50 and an <strong>AnalysisRun</strong> will start. It will determine later if the Rollout succeeds or not: if the Prometheus metric falls below 99% Success Share, the Rollout will be aborted immediately. On the other hand, if the Success Share stays above 99% for 10 minutes, the Rollout will complete successfully.</p>
<h2 id="detecting-and-aborting-rollouts-automatically">Detecting and Aborting Rollouts Automatically</h2>
<hr>
<p>Now that we‚Äôve seen how an <strong>AnalysisRun</strong> works in theory, let‚Äôs see it in practice, shall we?! üßê</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl argo rollouts dashboard -n argo-rollouts <span class="p">&amp;</span>
</span></span></code></pre></div><p>If you now head to <a href="http://localhost:3100/rollout/sample-app">http://localhost:3100/rollout/sample-app</a>, you should see a shiny dashboard showing the state of the <code>sample-app</code> Rollout.</p>
<p><img src="/images/smart-canary-deployment/1.png" alt="Argo Rollouts Dashboard"></p>
<p>Cool! So far, we can observe only one <strong>revision</strong> labeled as <code>stable</code>, serving 100% of the traffic.</p>
<p>Now, let‚Äôs set a new image for the container!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl argo rollouts <span class="nb">set</span> image sample-app sample-app<span class="o">=</span>ghcr.io/jhandguy/canary-deployment/sample-app:latest -n sample-app
</span></span></code></pre></div><p><img src="/images/smart-canary-deployment/2.png" alt="Argo Rollouts Dashboard"></p>
<p>Tada! The Rollout has just completed step 1: setting the <code>canary-weight</code> to 25%.</p>
<p>As you can see, the <strong>AnalysisRun</strong> has not yet started, this will only happen once we start step 2. Let‚Äôs proceed then!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl argo rollouts promote sample-app -n sample-app
</span></span></code></pre></div><p><img src="/images/smart-canary-deployment/3.png" alt="Argo Rollouts Dashboard"></p>
<p>Awesome! The <code>canary-weight</code> is now at 50% and an <strong>AnalysisRun</strong> has just started.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl get analysisrun -n sample-app
</span></span><span class="line"><span class="cl">NAME                      STATUS
</span></span><span class="line"><span class="cl">sample-app-5c9fc8b7d4-2   Running
</span></span></code></pre></div><p>Let‚Äôs have a deeper look at it!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl describe analysisrun -n sample-app
</span></span><span class="line"><span class="cl">Name:         sample-app-5c9fc8b7d4-2
</span></span><span class="line"><span class="cl">Namespace:    sample-app
</span></span><span class="line"><span class="cl">Labels:       rollout-type<span class="o">=</span>Background
</span></span><span class="line"><span class="cl">              rollouts-pod-template-hash<span class="o">=</span>5c9fc8b7d4
</span></span><span class="line"><span class="cl">Annotations:  rollout.argoproj.io/revision: <span class="m">2</span>
</span></span><span class="line"><span class="cl">API Version:  argoproj.io/v1alpha1
</span></span><span class="line"><span class="cl">Kind:         AnalysisRun
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Spec:
</span></span><span class="line"><span class="cl">  Metrics:
</span></span><span class="line"><span class="cl">    Failure Limit:  <span class="m">0</span>
</span></span><span class="line"><span class="cl">    Interval:       1m
</span></span><span class="line"><span class="cl">    Name:           success-share
</span></span><span class="line"><span class="cl">    Provider:
</span></span><span class="line"><span class="cl">      Prometheus:
</span></span><span class="line"><span class="cl">        Address:  http://prometheus-operated.prometheus.svc.cluster.local:9090
</span></span><span class="line"><span class="cl">        Query:    sum<span class="o">(</span>rate<span class="o">(</span>
</span></span><span class="line"><span class="cl">                    sample_app_requests_count<span class="o">{</span><span class="nv">service</span><span class="o">=</span><span class="s2">&#34;sample-app-canary&#34;</span>, <span class="nv">success</span><span class="o">=</span><span class="s2">&#34;true&#34;</span><span class="o">}[</span>1m<span class="o">])</span>
</span></span><span class="line"><span class="cl">                  <span class="o">)</span> by <span class="o">(</span>service<span class="o">)</span>
</span></span><span class="line"><span class="cl">                  /
</span></span><span class="line"><span class="cl">                  sum<span class="o">(</span>rate<span class="o">(</span>
</span></span><span class="line"><span class="cl">                    sample_app_requests_count<span class="o">{</span><span class="nv">service</span><span class="o">=</span><span class="s2">&#34;sample-app-canary&#34;</span><span class="o">}[</span>1m<span class="o">])</span>
</span></span><span class="line"><span class="cl">                  <span class="o">)</span> by <span class="o">(</span>service<span class="o">)</span>
</span></span><span class="line"><span class="cl">                  unless sum<span class="o">(</span>rate<span class="o">(</span>
</span></span><span class="line"><span class="cl">                    sample_app_requests_count<span class="o">{</span><span class="nv">service</span><span class="o">=</span><span class="s2">&#34;sample-app-canary&#34;</span><span class="o">}[</span>1m<span class="o">])</span>
</span></span><span class="line"><span class="cl">                  <span class="o">)</span> by <span class="o">(</span>service<span class="o">)</span> <span class="o">==</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">    Success Condition:  len<span class="o">(</span>result<span class="o">)</span> <span class="o">==</span> <span class="m">0</span> <span class="o">||</span> result<span class="o">[</span>0<span class="o">]</span> &gt;<span class="o">=</span> 0.99
</span></span><span class="line"><span class="cl">Status:
</span></span><span class="line"><span class="cl">  Metric Results:
</span></span><span class="line"><span class="cl">    Count:  <span class="m">1</span>
</span></span><span class="line"><span class="cl">    Measurements:
</span></span><span class="line"><span class="cl">      Finished At:  2022-01-29T18:37:49Z
</span></span><span class="line"><span class="cl">      Phase:        Successful
</span></span><span class="line"><span class="cl">      Started At:   2022-01-29T18:37:49Z
</span></span><span class="line"><span class="cl">      Value:        <span class="o">[]</span>
</span></span><span class="line"><span class="cl">    Name:           success-share
</span></span><span class="line"><span class="cl">    Phase:          Running
</span></span><span class="line"><span class="cl">    Successful:     <span class="m">1</span>
</span></span><span class="line"><span class="cl">  Phase:            Running
</span></span><span class="line"><span class="cl">  Started At:       2022-01-29T18:37:49Z
</span></span><span class="line"><span class="cl">Events:             &lt;none&gt;
</span></span></code></pre></div><p>As expected, the Spec part of the <strong>AnalysisRun</strong> is the same one we‚Äôve specified in the <strong>AnalysisTemplate</strong>.<br>
To monitor the progress of the Rollout, however, it is the <em>Status</em> and the <em>Events</em> that we will be looking at.</p>
<p>Right now, the measurement‚Äôs value is empty (<code>[]</code>), this is because the service has not recorded any metrics yet. Let‚Äôs change that and send some successful requests for Prometheus to scrape! üöÄ</p>
<blockquote>
<p>Since the PromQL query targets the canary Service specifically, we must make sure to always land in the canary Deployment using the Ingress <code>canary-by-header</code> annotation (learn more about it in <a href="/posts/simple-canary-deployment/">Part 1</a>).</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span> -H <span class="s2">&#34;X-Canary: always&#34;</span>
</span></span></code></pre></div><p>After firing some requests and waiting about a minute for Prometheus to scrape the metrics and the <strong>AnalysisRun</strong> to measure the <code>success-share</code> metric, you should see one of the measurements with a value of <code>[1]</code>, meaning that the Success Share has been successfully measured at 100%! üíØ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl describe analysisrun -n sample-app
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Status:
</span></span><span class="line"><span class="cl">  Metric Results:
</span></span><span class="line"><span class="cl">    Count:  <span class="m">5</span>
</span></span><span class="line"><span class="cl">    Measurements:
</span></span><span class="line"><span class="cl">      ...
</span></span><span class="line"><span class="cl">      Finished At:  2022-01-29T18:41:49Z
</span></span><span class="line"><span class="cl">      Phase:        Successful
</span></span><span class="line"><span class="cl">      Started At:   2022-01-29T18:41:49Z
</span></span><span class="line"><span class="cl">      Value:        <span class="o">[</span>1<span class="o">]</span>
</span></span><span class="line"><span class="cl">    Name:           success-share
</span></span><span class="line"><span class="cl">    Phase:          Running
</span></span><span class="line"><span class="cl">    Successful:     <span class="m">5</span>
</span></span><span class="line"><span class="cl">  Phase:            Running
</span></span><span class="line"><span class="cl">  Started At:       2022-01-29T18:37:49Z
</span></span><span class="line"><span class="cl">Events:             &lt;none&gt;
</span></span></code></pre></div><p>The best part of this is, that while all of this was happening, the Rollout kept on progressing and has probably already reached the next step: increasing the <code>canary-weight</code> to 75%.</p>
<p><img src="/images/smart-canary-deployment/4.png" alt="Argo Rollouts Dashboard"></p>
<p>That‚Äôs great! But let‚Äôs make things more interesting: what happens once the Success Share falls below 99%? üò±</p>
<p>Let‚Äôs go ahead and simulate a 50% Success Share by sending several requests and alternating between successes and errors!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">curl localhost/success -H <span class="s2">&#34;Host: sample.app&#34;</span> -H <span class="s2">&#34;X-Canary: always&#34;</span>
</span></span><span class="line"><span class="cl">curl localhost/error -H <span class="s2">&#34;Host: sample.app&#34;</span> -H <span class="s2">&#34;X-Canary: always&#34;</span>
</span></span></code></pre></div><p>After a short while, you should notice that something quite magical has happened‚Ä¶ ü™Ñ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl describe analysisrun -n sample-app
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Status:
</span></span><span class="line"><span class="cl">  Message:  metric <span class="s2">&#34;success-share&#34;</span> assessed Failed due to failed <span class="o">(</span>1<span class="o">)</span> &gt; failureLimit <span class="o">(</span>0<span class="o">)</span>
</span></span><span class="line"><span class="cl">  Metric Results:
</span></span><span class="line"><span class="cl">    Count:   <span class="m">9</span>
</span></span><span class="line"><span class="cl">    Failed:  <span class="m">1</span>
</span></span><span class="line"><span class="cl">    Measurements:
</span></span><span class="line"><span class="cl">      ...
</span></span><span class="line"><span class="cl">      Finished At:  2022-01-29T18:45:49Z
</span></span><span class="line"><span class="cl">      Phase:        Failed
</span></span><span class="line"><span class="cl">      Started At:   2022-01-29T18:45:49Z
</span></span><span class="line"><span class="cl">      Value:        <span class="o">[</span>0.5<span class="o">]</span>
</span></span><span class="line"><span class="cl">    Name:           success-share
</span></span><span class="line"><span class="cl">    Phase:          Failed
</span></span><span class="line"><span class="cl">    Successful:     <span class="m">8</span>
</span></span><span class="line"><span class="cl">  Phase:            Failed
</span></span><span class="line"><span class="cl">  Started At:       2022-01-29T18:37:49Z
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type     Reason             Age   From                 Message
</span></span><span class="line"><span class="cl">  ----     ------             ----  ----                 -------
</span></span><span class="line"><span class="cl">  Warning  MetricFailed       17s   rollouts-controller  metric <span class="s1">&#39;success-share&#39;</span> completed Failed
</span></span><span class="line"><span class="cl">  Warning  AnalysisRunFailed  17s   rollouts-controller  analysis completed Failed
</span></span></code></pre></div><p>As soon as the <strong>AnalysisRun</strong> recorded a measurement breaching below the 99% Success Share threshold, the Rollout was immediately aborted.</p>
<p>Let‚Äôs confirm that from the Rollout‚Äôs status real quick!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl argo rollouts status sample-app -n sample-app
</span></span><span class="line"><span class="cl">Degraded
</span></span><span class="line"><span class="cl">Error: The rollout is in a degraded state with message: RolloutAborted: Rollout aborted update to revision 2: metric <span class="s2">&#34;success-share&#34;</span> assessed Failed due to failed <span class="o">(</span>1<span class="o">)</span> &gt; failureLimit <span class="o">(</span>0<span class="o">)</span>
</span></span></code></pre></div><p>Indeed, even the Dashboard highlights that the Rollout is in a <em>Degraded</em> state, and consequently the <code>canary-weight</code> has been taken down to 0%.</p>
<p><img src="/images/smart-canary-deployment/5.png" alt="Argo Rollouts Dashboard"></p>
<p>This would, in practice, give us time to investigate the issue, and once fixed, <strong>retry</strong> the Rollout, either via the CLI or the Dashboard‚Äôs <em>RETRY</em> button.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl argo rollouts retry rollout sample-app -n sample-app
</span></span><span class="line"><span class="cl">kubectl argo rollouts promote sample-app -n sample-app
</span></span></code></pre></div><p>Now that the Rollout has restarted and reached step 2, a new <strong>AnalysisRun</strong> has started and the incremental rollout is back on track! üõ§</p>
<p><img src="/images/smart-canary-deployment/6.png" alt="Argo Rollouts Dashboard"></p>
<h3 id="load-testing-with-k6">Load Testing with k6</h3>
<hr>
<p>Instead of running some <code>curl</code> commands like we previously did, how about we execute a Load Test instead?</p>
<p>For Load Testing, I really recommend <a href="https://k6.io/docs/">k6</a> from the Grafana Labs team. It is a dead-simple yet super powerful tool with very extensive documentation.</p>
<p>See for yourself!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">k6 run k6/script.js
</span></span></code></pre></div><p>After about 1 minute, k6 should be done executing the load test and show you the results.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">          /<span class="se">\ </span>     <span class="p">|</span>‚Äæ‚Äæ<span class="p">|</span> /‚Äæ‚Äæ/   /‚Äæ‚Äæ/
</span></span><span class="line"><span class="cl">     /<span class="se">\ </span> /  <span class="se">\ </span>    <span class="p">|</span>  <span class="p">|</span>/  /   /  /
</span></span><span class="line"><span class="cl">    /  <span class="se">\/</span>    <span class="se">\ </span>   <span class="p">|</span>     <span class="o">(</span>   /   ‚Äæ‚Äæ<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   /          <span class="se">\ </span>  <span class="p">|</span>  <span class="p">|</span><span class="se">\ </span> <span class="se">\ </span><span class="p">|</span>  <span class="o">(</span>‚Äæ<span class="o">)</span>  <span class="p">|</span>
</span></span><span class="line"><span class="cl">  / __________ <span class="se">\ </span> <span class="p">|</span>__<span class="p">|</span> <span class="se">\_</span>_<span class="se">\ \_</span>____/ .io
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  execution: <span class="nb">local</span>
</span></span><span class="line"><span class="cl">     script: k6/script.js
</span></span><span class="line"><span class="cl">     output: -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  scenarios: <span class="o">(</span>100.00%<span class="o">)</span> <span class="m">1</span> scenario, <span class="m">20</span> max VUs, 1m30s max duration <span class="o">(</span>incl. graceful stop<span class="o">)</span>:
</span></span><span class="line"><span class="cl">           * load: Up to 20.00 iterations/s <span class="k">for</span> 1m0s over <span class="m">2</span> stages <span class="o">(</span>maxVUs: 20, gracefulStop: 30s<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     ‚úì status code is <span class="m">200</span>
</span></span><span class="line"><span class="cl">     ‚úì node is kind-control-plane
</span></span><span class="line"><span class="cl">     ‚úì namespace is sample-app
</span></span><span class="line"><span class="cl">     ‚úì pod is sample-app-*
</span></span><span class="line"><span class="cl">     ‚úì deployment is stable or canary
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   ‚úì checks.........................: 100.00% ‚úì <span class="m">3095</span>      ‚úó <span class="m">0</span>
</span></span><span class="line"><span class="cl">     data_received..................: <span class="m">157</span> kB  2.6 kB/s
</span></span><span class="line"><span class="cl">     data_sent......................: <span class="m">71</span> kB   1.2 kB/s
</span></span><span class="line"><span class="cl">     http_req_blocked...............: <span class="nv">avg</span><span class="o">=</span>41.24¬µs <span class="nv">min</span><span class="o">=</span>3¬µs    <span class="nv">med</span><span class="o">=</span>8¬µs    <span class="nv">max</span><span class="o">=</span>3.39ms  p<span class="o">(</span>90<span class="o">)=</span>19¬µs   p<span class="o">(</span>95<span class="o">)=</span>55.19¬µs
</span></span><span class="line"><span class="cl">     http_req_connecting............: <span class="nv">avg</span><span class="o">=</span>21.96¬µs <span class="nv">min</span><span class="o">=</span>0s     <span class="nv">med</span><span class="o">=</span>0s     <span class="nv">max</span><span class="o">=</span>2.71ms  p<span class="o">(</span>90<span class="o">)=</span>0s     p<span class="o">(</span>95<span class="o">)=</span>0s
</span></span><span class="line"><span class="cl">   ‚úì http_req_duration..............: <span class="nv">avg</span><span class="o">=</span>3.75ms  <span class="nv">min</span><span class="o">=</span>940¬µs  <span class="nv">med</span><span class="o">=</span>2.96ms <span class="nv">max</span><span class="o">=</span>17.22ms p<span class="o">(</span>90<span class="o">)=</span>6.99ms p<span class="o">(</span>95<span class="o">)=</span>9.37ms
</span></span><span class="line"><span class="cl">       <span class="o">{</span> expected_response:true <span class="o">}</span>...: <span class="nv">avg</span><span class="o">=</span>3.75ms  <span class="nv">min</span><span class="o">=</span>940¬µs  <span class="nv">med</span><span class="o">=</span>2.96ms <span class="nv">max</span><span class="o">=</span>17.22ms p<span class="o">(</span>90<span class="o">)=</span>6.99ms p<span class="o">(</span>95<span class="o">)=</span>9.37ms
</span></span><span class="line"><span class="cl">     http_req_failed................: 0.00%   ‚úì <span class="m">0</span>         ‚úó <span class="m">619</span>
</span></span><span class="line"><span class="cl">     http_req_rate..................: 50.00%  ‚úì <span class="m">619</span>       ‚úó <span class="m">619</span>
</span></span><span class="line"><span class="cl">     ‚úì <span class="o">{</span> deployment:canary <span class="o">}</span>........: 49.91%  ‚úì <span class="m">309</span>       ‚úó <span class="m">310</span>
</span></span><span class="line"><span class="cl">     ‚úì <span class="o">{</span> deployment:stable <span class="o">}</span>........: 50.08%  ‚úì <span class="m">310</span>       ‚úó <span class="m">309</span>
</span></span><span class="line"><span class="cl">     http_req_receiving.............: <span class="nv">avg</span><span class="o">=</span>107.1¬µs <span class="nv">min</span><span class="o">=</span>24¬µs   <span class="nv">med</span><span class="o">=</span>88¬µs   <span class="nv">max</span><span class="o">=</span>2.09ms  p<span class="o">(</span>90<span class="o">)=</span>165¬µs  p<span class="o">(</span>95<span class="o">)=</span>189.09¬µs
</span></span><span class="line"><span class="cl">     http_req_sending...............: <span class="nv">avg</span><span class="o">=</span>50.78¬µs <span class="nv">min</span><span class="o">=</span>14¬µs   <span class="nv">med</span><span class="o">=</span>36¬µs   <span class="nv">max</span><span class="o">=</span>837¬µs   p<span class="o">(</span>90<span class="o">)=</span>77¬µs   p<span class="o">(</span>95<span class="o">)=</span>114.19¬µs
</span></span><span class="line"><span class="cl">     http_req_tls_handshaking.......: <span class="nv">avg</span><span class="o">=</span>0s      <span class="nv">min</span><span class="o">=</span>0s     <span class="nv">med</span><span class="o">=</span>0s     <span class="nv">max</span><span class="o">=</span>0s      p<span class="o">(</span>90<span class="o">)=</span>0s     p<span class="o">(</span>95<span class="o">)=</span>0s
</span></span><span class="line"><span class="cl">     http_req_waiting...............: <span class="nv">avg</span><span class="o">=</span>3.6ms   <span class="nv">min</span><span class="o">=</span>857¬µs  <span class="nv">med</span><span class="o">=</span>2.78ms <span class="nv">max</span><span class="o">=</span>17.09ms p<span class="o">(</span>90<span class="o">)=</span>6.81ms p<span class="o">(</span>95<span class="o">)=</span>9.1ms
</span></span><span class="line"><span class="cl">     http_reqs......................: <span class="m">619</span>     10.316653/s
</span></span><span class="line"><span class="cl">     iteration_duration.............: <span class="nv">avg</span><span class="o">=</span>4.31ms  <span class="nv">min</span><span class="o">=</span>1.09ms <span class="nv">med</span><span class="o">=</span>3.53ms <span class="nv">max</span><span class="o">=</span>21.84ms p<span class="o">(</span>90<span class="o">)=</span>7.82ms p<span class="o">(</span>95<span class="o">)=</span>10.34ms
</span></span><span class="line"><span class="cl">     iterations.....................: <span class="m">619</span>     10.316653/s
</span></span><span class="line"><span class="cl">     vus............................: <span class="m">0</span>       <span class="nv">min</span><span class="o">=</span><span class="m">0</span>       <span class="nv">max</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">     vus_max........................: <span class="m">20</span>      <span class="nv">min</span><span class="o">=</span><span class="m">20</span>      <span class="nv">max</span><span class="o">=</span><span class="m">20</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">running <span class="o">(</span>1m00.0s<span class="o">)</span>, 00/20 VUs, <span class="m">619</span> <span class="nb">complete</span> and <span class="m">0</span> interrupted iterations
</span></span><span class="line"><span class="cl">load ‚úì <span class="o">[======================================]</span> 00/20 VUs  1m0s  00.71 iters/s
</span></span></code></pre></div><p>That sounds about right!<br>
Depending on which step the Rollout is at, the Traffic Distribution shown in k6‚Äôs output should be either 50/50 or 75/25.</p>
<p>Same as before, if you now describe the <strong>AnalysisRun</strong>, you should see some successful measurements were measured.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">‚ûú kubectl describe analysisrun -n sample-app
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Status:
</span></span><span class="line"><span class="cl">  Metric Results:
</span></span><span class="line"><span class="cl">    Count:  <span class="m">5</span>
</span></span><span class="line"><span class="cl">    Measurements:
</span></span><span class="line"><span class="cl">      ...
</span></span><span class="line"><span class="cl">      Phase:        Successful
</span></span><span class="line"><span class="cl">      Started At:   2022-01-30T14:34:07Z
</span></span><span class="line"><span class="cl">      Value:        <span class="o">[</span>1<span class="o">]</span>
</span></span><span class="line"><span class="cl">    Name:           success-share
</span></span><span class="line"><span class="cl">    Phase:          Running
</span></span><span class="line"><span class="cl">    Successful:     <span class="m">5</span>
</span></span><span class="line"><span class="cl">  Phase:            Running
</span></span><span class="line"><span class="cl">  Started At:       2022-01-30T14:32:07Z
</span></span><span class="line"><span class="cl">Events:             &lt;none&gt;
</span></span></code></pre></div><p>Eventually, the Rollout should complete successfully and the new revision should become the new <code>stable</code> Deployment! üéâ</p>
<p><img src="/images/smart-canary-deployment/7.png" alt="Argo Rollouts Dashboard"></p>
<h2 id="wrapping-up">Wrapping up</h2>
<hr>
<p>That‚Äôs it! You can now delete your Kind cluster!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kind delete cluster
</span></span></code></pre></div><p>To summarize, using Argo Rollouts and Prometheus we were able to:</p>
<ul>
<li>Detect when a Prometheus metric breaches a given threshold and abort the faulty Rollout automatically, thanks to the <strong>AnalysisRun</strong> CRD;</li>
<li>Restart the aborted Rollout effortlessly once the issue is fixed.</li>
</ul>
<p>Was it worth it? Did that help you understand how to implement Canary Deployment in Kubernetes using Argo Rollouts and Prometheus?</p>
<p>If so, follow me on <a href="https://twitter.com/jhandguy">Twitter</a>, I‚Äôll be happy to answer any of your questions and you‚Äôll be the first one to know when a new article comes out! üëå</p>
<p>Bye-bye! üëã</p>

        </div>
    </div>
</section>

</body>
<footer>
    <div class="footer pt-3 has-background-black-bis">
        <div class="container pb-6 has-text-centered is-mobile columns">
            <div class="column is-narrow paddingless">
                
                
                <a class="button is-large" href="https://jhandguy.github.io/posts/automated-canary-deployment/"><strong>üëà</strong></a>
                
                
            </div>
            <div class="column"></div>
            <div class="column is-narrow paddingless">
                <a class="button is-large" href="#"><strong>üëÜ</strong></a>
            </div>
            <div class="column"></div>
            <div class="column is-narrow paddingless">
                
                
                <a class="button is-large" href="https://jhandguy.github.io/posts/incremental-mobile-force-update/"><strong>üëâ</strong></a>
                
                
            </div>
        </div>
        <div class="content has-text-centered">
            <p class="subtitle is-6">Powered by <a href="https://gohugo.io/">Hugo</a></p>
            <a href="https://bulma.io">
                <img src="/images/footer/made-with-bulma.png" alt="Made with Bulma" width="128" height="24">
            </a>
        </div>
    </div>
</footer>

</html>
