<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Canary Deployment in Kubernetes (Part 3) ‚Äî Smart Canary Deployment using Argo Rollouts and Prometheus</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="/css/custom.css">
</head>

<body id="top" class="has-background-white">
<nav class="navbar is-dark">
    <div class="navbar-brand">
        <a class="navbar-item" href="/">
            Home
        </a>

        <div class="navbar-item">
            <a class="button is-primary" href="/about">
                <strong>About me</strong>
            </a>
        </div>
    </div>
</nav>
<section class="section">
    <div class="container is-max-desktop">
        <div class="content is-large">
            <h1 class="title">Canary Deployment in Kubernetes (Part 3) ‚Äî Smart Canary Deployment using Argo Rollouts and Prometheus</h1>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#using-argo-rollouts-with-prometheus">Using Argo Rollouts with Prometheus</a>
      <ul>
        <li><a href="#installing-nginx-ingress-controller">Installing NGINX Ingress Controller</a></li>
        <li><a href="#installing-argo-rollouts">Installing Argo Rollouts</a></li>
        <li><a href="#installing-prometheus">Installing Prometheus</a></li>
      </ul>
    </li>
    <li><a href="#automating-rollbacks-using-analysistemplates">Automating Rollbacks using AnalysisTemplates</a></li>
    <li><a href="#detecting-and-aborting-rollouts-automatically">Detecting and Aborting Rollouts Automatically</a>
      <ul>
        <li><a href="#load-testing-with-k6">Load Testing with k6</a></li>
      </ul>
    </li>
    <li><a href="#wrapping-up">Wrapping up</a></li>
  </ul>
</nav>
        </div>
    </div>
    <div class="container is-max-desktop mt-6">
        <div class="content is-medium has-text-justified-tablet">
            <p>Deploying to production in Kubernetes can be quite stressful. Even after meaningful and reliable automated tests have successfully passed, there is still room for things to go wrong and lead to a nasty incident when pressing the final button.</p>
<p>Thankfully, Kubernetes is made to be resilient to this kind of scenario, and rolling back is a no-brainer. But still, rolling back means that, at least for some time, <strong>all of the users</strong> were negatively impacted by the faulty change‚Ä¶</p>
<p>What if we could smoke test our change in production <strong>before</strong> it actually hits real users? What if we could roll out a change incrementally to <strong>some users</strong> instead of all of them at once? What if we could detect a faulty deployment and roll it back automatically?<br>
Well, that, my friend, is what Canary Deployment is all about!</p>
<blockquote>
<p>Minimizing the impact on real users while deploying a risky change to production.</p>
</blockquote>
<p>üé¨ Hi there, I‚Äôm Jean!</p>
<p>In this 3 parts series, we‚Äôre going to explore several ways to do Canary Deployment in Kubernetes, and the first one is‚Ä¶<br>
ü•Å<br>
‚Ä¶ using <strong>Argo Rollouts and Prometheus</strong>! üéä</p>
<h2 id="requirements">Requirements</h2>
<hr>
<p>Before we start, make sure you have the following tools installed:</p>
<ul>
<li><a href="https://minikube.sigs.k8s.io/docs/start/">Minikube</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/">Kubectl</a></li>
<li><a href="https://argoproj.github.io/argo-rollouts/installation/#kubectl-plugin-installation">Argo Rollouts Kubectl Plugin</a></li>
<li><a href="https://helm.sh/docs/intro/install/">Helm</a></li>
<li><a href="https://k6.io/docs/getting-started/installation/">K6</a></li>
</ul>
<blockquote>
<p><em>Note: for MacOS users or Linux users using Homebrew, simply run:</em><br>
<code>brew install minikube kubectl argoproj/tap/kubectl-argo-rollouts helm k6</code></p>
</blockquote>
<p>All set? Let‚Äôs go! üèÅ</p>
<h2 id="using-argo-rollouts-with-prometheus">Using Argo Rollouts with Prometheus</h2>
<hr>
<p><a href="https://argoproj.github.io/argo-rollouts/">Argo Rollouts</a> is a <a href="https://kubernetes.io/docs/concepts/architecture/controller/">Kubernetes controller</a> and set of <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">CRDs</a> which provide advanced deployment capabilities to Kubernetes such as blue-green, canary, canary analysis, experimentation, and progressive delivery.</p>
<p>In combination with <a href="https://prometheus.io/">Prometheus</a>, Argo Rollouts can automatically roll back a Canary Deployment based on Prometheus metrics, which means it can theoretically handle an incremental rollout without human intervention.</p>
<h3 id="installing-nginx-ingress-controller">Installing NGINX Ingress Controller</h3>
<hr>
<blockquote>
<p><em>If you haven‚Äôt already, go read <a href="/posts/simple-canary-deployment/">Canary Deployment in Kubernetes (Part 1) ‚Äî Simple Canary Deployment using Ingress NGINX</a> and learn how to implement a Simple Canary Deployment using Ingress NGINX!</em></p>
</blockquote>
<p><a href="https://github.com/kubernetes/ingress-nginx">NGINX Ingress Controller</a> is one of the <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/#additional-controllers">many available Kubernetes Ingress Controllers</a>, which acts as a load balancer and satisfies routing rules specified in <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#what-is-ingress">Ingress</a> resources, using the <a href="https://nginx.org/en/">NGINX reverse proxy</a>.</p>
<blockquote>
<p><strong>In a production Kubernetes cluster, it is recommended to install the NGINX Ingress Controller via its <a href="https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx">Helm chart</a>.</strong></p>
</blockquote>
<p>However, since we will be using <a href="https://minikube.sigs.k8s.io/docs/start/">Minikube</a> in this series, the dedicated <a href="https://kubernetes.io/docs/tasks/access-application-cluster/ingress-minikube/#enable-the-ingress-controller">ingress add-on</a> will suffice.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">minikube start --kubernetes-version<span style="color:#f92672">=</span>1.21.8 --addons<span style="color:#f92672">=</span>ingress <span style="color:#66d9ef">$(if</span> <span style="color:#f92672">[</span> <span style="color:#66d9ef">$(</span>uname<span style="color:#66d9ef">)</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Linux&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span> echo <span style="color:#e6db74">&#34;--vm=true&#34;</span>; <span style="color:#66d9ef">fi)</span>
</code></pre></div><blockquote>
<p><em>Note: Argo Rollouts is still expecting the extensions/v1beta1 API version of the Ingress resource while it is no longer available in Kubernetes since v1.22.<br>
<a href="https://github.com/argoproj/argo-rollouts/issues/1507">The issue</a> has already been fixed but hasn‚Äôt been released yet, this is why we need to restrict the kubernetes version to 1.21 for now.</em></p>
</blockquote>
<p>Now, if everything goes according to plan, you should be able to see the <strong>ingress-nginx-controller</strong> Deployment running in your freshly created Minikube cluster.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">‚ûú kubectl get deploy -n ingress-nginx
NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
ingress-nginx-controller   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           4m35s
</code></pre></div><h3 id="installing-argo-rollouts">Installing Argo Rollouts</h3>
<hr>
<blockquote>
<p><em>If you haven‚Äôt already, go read <a href="/posts/automated-canary-deployment/">Canary Deployment in Kubernetes (Part 2) ‚Äî Automated Canary Deployment using Argo Rollouts</a> and learn how to implement a Canary Deployment using Argo Rollouts!</em></p>
</blockquote>
<p>Argo Rollouts can be installed via its <a href="https://github.com/argoproj/argo-helm/tree/master/charts/argo-rollouts">Helm chart</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">helm repo add argo https://argoproj.github.io/argo-helm
helm install argo/argo-rollouts --name-template argo-rollouts --create-namespace -n argo-rollouts --set dashboard.enabled<span style="color:#f92672">=</span>true --wait
</code></pre></div><p>If all goes well, you should see two newly spawned Deployments with the READY state.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">‚ûú kubectl get deploy -n argo-rollouts
NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
argo-rollouts             1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           13m
argo-rollouts-dashboard   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           13m
</code></pre></div><h3 id="installing-prometheus">Installing Prometheus</h3>
<hr>
<p>Prometheus can be installed via its community <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack">Helm chart</a>, which also provides <a href="https://grafana.com/grafana/">Grafana</a> out of the box.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm install prometheus-community/kube-prometheus-stack --name-template prometheus --create-namespace -n prometheus --wait
</code></pre></div><p>If everything went fine, you should be able to see three newly spawned deployments with the READY state!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">‚ûú kubectl get deploy -n prometheus
NAME                                  READY   UP-TO-DATE   AVAILABLE   
prometheus-grafana                    1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           
prometheus-kube-prometheus-operator   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           
prometheus-kube-state-metrics         1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>  
</code></pre></div><h2 id="automating-rollbacks-using-analysistemplates">Automating Rollbacks using AnalysisTemplates</h2>
<hr>
<p>In <a href="/posts/automated-canary-deployment/">Part 2</a>, we learned how to configure a Rollout and how to automate the Traffic Routing increments via Rollout <code>steps</code>.<br>
Yet another amazing feature of Argo Rollouts is the ability to leverage Prometheus metrics in order to detect faulty deployments (i.e. based on request Success Share or Latency).</p>
<p>To this end, Argo Rollouts provides another <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">Custom Resource</a> called <strong>AnalysisTemplate</strong>.<br>
Alright! Let‚Äôs explore what this is!</p>
<p>I don‚Äôt expect you to have a Helm chart with a demo app in handy, so I <a href="https://github.com/jhandguy/canary-deployment">built one</a> for you.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/jhandguy/canary-deployment.git
cd canary-deployment/argo-rollouts
helm install . --name-template sample-app --create-namespace -n sample-app --set prometheus.enabled<span style="color:#f92672">=</span>true
</code></pre></div><p>If everything goes fine, you should eventually see one Rollout with the READY state.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">‚ûú kubectl get rollout sample-app -n sample-app
NAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE
sample-app   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>
</code></pre></div><p>Alright, let‚Äôs have a look at the <code>analysistemplate.yaml</code> and the <code>rollout.yaml</code> inside the <code>templates</code> folder!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">‚ûú ls -1 templates
analysistemplate.yaml
canary
ingress.yaml
rollout.yaml
service.yaml
serviceaccount.yaml
servicemonitor.yaml
</code></pre></div><p>An <strong>AnalysisTemplate</strong> is a template <em>spec</em> that defines how to perform a canary analysis. It consists of a Prometheus metric which is being evaluated, at a given interval, against a given success condition.</p>
<p>In this example, the Prometheus metric is a <em>Success Share</em>, with a minimum threshold of 99% and an interval of 1 minute. The failure limit is 0, meaning that as soon as it fails, the Rollout will be aborted. Since it is the canary Deployment that we are trying to evaluate, the PromQL query must target it specifically via the <em>service</em> label.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">argoproj.io/v1alpha1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">AnalysisTemplate</span>
...
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">metrics</span>:
    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">success-share</span>
      <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">1m</span>
      <span style="color:#f92672">successCondition</span>: <span style="color:#ae81ff">len(result) == 0 || result[0] &gt;= 0.99</span>
      <span style="color:#f92672">failureLimit</span>: <span style="color:#ae81ff">0</span>
      <span style="color:#f92672">provider</span>:
        <span style="color:#f92672">prometheus</span>:
          <span style="color:#f92672">address</span>: {{ <span style="color:#ae81ff">.Values.prometheus.address }}</span>
          <span style="color:#f92672">query</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">            sum(rate(
</span><span style="color:#e6db74">              sample_app_requests_count{service=&#34;{{ .Release.Name }}-canary&#34;, success=&#34;true&#34;}[1m])
</span><span style="color:#e6db74">            ) by (service)
</span><span style="color:#e6db74">            /
</span><span style="color:#e6db74">            sum(rate(
</span><span style="color:#e6db74">              sample_app_requests_count{service=&#34;{{ .Release.Name }}-canary&#34;}[1m])
</span><span style="color:#e6db74">            ) by (service)
</span><span style="color:#e6db74">            unless sum(rate(
</span><span style="color:#e6db74">              sample_app_requests_count{service=&#34;{{ .Release.Name }}-canary&#34;}[1m])
</span><span style="color:#e6db74">            ) by (service) == 0</span>            
</code></pre></div><p>The instantiation of an <strong>AnalysisTemplate</strong> is called an <strong>AnalysisRun</strong>. It is like a <em>Job</em>, meaning it eventually completes, with a result of either Successful, Failed, or Inconclusive. If successful, the rollout continues, if failed, it is aborted and if inconclusive, it is paused.</p>
<p>There are two ways to define an <strong>AnalysisTemplate</strong>:</p>
<ol>
<li><strong>Background Analysis</strong><br>
This Analysis runs in the background, while the Rollout is progressing through its steps. If the <strong>AnalysisRun</strong> fails, the Rollout is aborted. On the other hand, if the <strong>AnalysisRun</strong> succeeds or all the Rollout steps are finished before it completes, the Rollout is considered successful.</li>
<li><strong>Inline Analysis</strong><br>
This Analysis runs as part of the Rollout steps. This means that the Rollout will wait for the <strong>AnalysisRun</strong> to complete, before proceeding to the next step, or aborting the rollout depending on the outcome.</li>
</ol>
<p>In our case, we will be using the Background Analysis, as it will detect a faulty deployment sooner than an Inline Analysis would.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">argoproj.io/v1alpha1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Rollout</span>
...
<span style="color:#f92672">spec</span>:
  <span style="color:#ae81ff">...</span>
  <span style="color:#f92672">strategy</span>:
    <span style="color:#f92672">canary</span>:
      <span style="color:#ae81ff">...</span>
      <span style="color:#f92672">steps</span>:
        - <span style="color:#f92672">setWeight</span>: <span style="color:#ae81ff">25</span>
        - <span style="color:#f92672">pause</span>: {}
        - <span style="color:#f92672">setWeight</span>: <span style="color:#ae81ff">50</span>
        - <span style="color:#f92672">pause</span>:
            <span style="color:#f92672">duration</span>: <span style="color:#ae81ff">5m</span>
        - <span style="color:#f92672">setWeight</span>: <span style="color:#ae81ff">75</span>
        - <span style="color:#f92672">pause</span>:
            <span style="color:#f92672">duration</span>: <span style="color:#ae81ff">5m</span>
      <span style="color:#f92672">analysis</span>:
        <span style="color:#f92672">templates</span>:
          - <span style="color:#f92672">templateName</span>: {{ <span style="color:#ae81ff">.Release.Name }}</span>
        <span style="color:#f92672">startingStep</span>: <span style="color:#ae81ff">2</span>
      <span style="color:#ae81ff">...</span>
  <span style="color:#ae81ff">...</span>
</code></pre></div><p>As you can see, the Analysis has been scheduled to start after step 2.<br>
Meaning, once the Rollout is promoted, the <code>canary-weight</code> will be set to 50 and an <strong>AnalysisRun</strong> will start. It will determine later if the Rollout succeeds or not: if the Prometheus metric falls below 99% Success Share, the Rollout will be aborted immediately. On the other hand, if the Success Share stays above 99% for 10 minutes, the Rollout will complete successfully.</p>
<h2 id="detecting-and-aborting-rollouts-automatically">Detecting and Aborting Rollouts Automatically</h2>
<hr>
<p>Now that we‚Äôve seen how an <strong>AnalysisRun</strong> works in theory, let‚Äôs see it in practice, shall we?! üßê</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl argo rollouts dashboard -n argo-rollouts &amp;
</code></pre></div><p>If you now head to <a href="http://localhost:3100/rollout/sample-app">http://localhost:3100/rollout/sample-app</a>, you should see a shiny dashboard showing the state of the <code>sample-app</code> Rollout.</p>
<p><img src="/images/smart-canary-deployment/1.png" alt="Argo Rollouts Dashboard"></p>
<p>Cool! So far, we can observe only one <strong>revision</strong> labeled as <code>stable</code>, serving 100% of the traffic.</p>
<p>Now, let‚Äôs set a new image for the container!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl argo rollouts set image sample-app sample-app<span style="color:#f92672">=</span>ghcr.io/jhandguy/canary-deployment/sample-app:latest -n sample-app
</code></pre></div><p><img src="/images/smart-canary-deployment/2.png" alt="Argo Rollouts Dashboard"></p>
<p>Tada! The Rollout has just completed step 1: setting the <code>canary-weight</code> to 25%.</p>
<p>As you can see, the <strong>AnalysisRun</strong> has not yet started, this will only happen once we start step 2. Let‚Äôs proceed then!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl argo rollouts promote sample-app -n sample-app
</code></pre></div><p><img src="/images/smart-canary-deployment/3.png" alt="Argo Rollouts Dashboard"></p>
<p>Awesome! The <code>canary-weight</code> is now at 50% and an <strong>AnalysisRun</strong> has just started.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">‚ûú kubectl get analysisrun -n sample-app
NAME                      STATUS
sample-app-5c9fc8b7d4-2   Running
</code></pre></div><p>Let‚Äôs have a deeper look at it!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">‚ûú kubectl describe analysisrun -n sample-app
Name:         sample-app-5c9fc8b7d4-2
Namespace:    sample-app
Labels:       rollout-type<span style="color:#f92672">=</span>Background
              rollouts-pod-template-hash<span style="color:#f92672">=</span>5c9fc8b7d4
Annotations:  rollout.argoproj.io/revision: <span style="color:#ae81ff">2</span>
API Version:  argoproj.io/v1alpha1
Kind:         AnalysisRun
...
Spec:
  Metrics:
    Failure Limit:  <span style="color:#ae81ff">0</span>
    Interval:       1m
    Name:           success-share
    Provider:
      Prometheus:
        Address:  http://prometheus-operated.prometheus.svc.cluster.local:9090
        Query:    sum<span style="color:#f92672">(</span>rate<span style="color:#f92672">(</span>
                    sample_app_requests_count<span style="color:#f92672">{</span>service<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sample-app-canary&#34;</span>, success<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}[</span>1m<span style="color:#f92672">])</span>
                  <span style="color:#f92672">)</span> by <span style="color:#f92672">(</span>service<span style="color:#f92672">)</span>
                  /
                  sum<span style="color:#f92672">(</span>rate<span style="color:#f92672">(</span>
                    sample_app_requests_count<span style="color:#f92672">{</span>service<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sample-app-canary&#34;</span><span style="color:#f92672">}[</span>1m<span style="color:#f92672">])</span>
                  <span style="color:#f92672">)</span> by <span style="color:#f92672">(</span>service<span style="color:#f92672">)</span>
                  unless sum<span style="color:#f92672">(</span>rate<span style="color:#f92672">(</span>
                    sample_app_requests_count<span style="color:#f92672">{</span>service<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sample-app-canary&#34;</span><span style="color:#f92672">}[</span>1m<span style="color:#f92672">])</span>
                  <span style="color:#f92672">)</span> by <span style="color:#f92672">(</span>service<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
    Success Condition:  len<span style="color:#f92672">(</span>result<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> result<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> &gt;<span style="color:#f92672">=</span> 0.99
Status:
  Metric Results:
    Count:  <span style="color:#ae81ff">1</span>
    Measurements:
      Finished At:  2022-01-29T18:37:49Z
      Phase:        Successful
      Started At:   2022-01-29T18:37:49Z
      Value:        <span style="color:#f92672">[]</span>
    Name:           success-share
    Phase:          Running
    Successful:     <span style="color:#ae81ff">1</span>
  Phase:            Running
  Started At:       2022-01-29T18:37:49Z
Events:             &lt;none&gt;
</code></pre></div><p>As expected, the Spec part of the <strong>AnalysisRun</strong> is the same one we‚Äôve specified in the <strong>AnalysisTemplate</strong>.<br>
To monitor the progress of the Rollout, however, it is the <em>Status</em> and the <em>Events</em> that we will be looking at.</p>
<p>Right now, the measurement‚Äôs value is empty (<code>[]</code>), this is because the service has not recorded any metrics yet. Let‚Äôs change that and send some successful requests for Prometheus to scrape! üöÄ</p>
<blockquote>
<p>Since the PromQL query targets the canary Service specifically, we must make sure to always land in the canary Deployment using the Ingress <code>canary-by-header</code> annotation (learn more about it in <a href="/posts/simple-canary-deployment/">Part 1</a>).</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl <span style="color:#66d9ef">$(</span>minikube ip<span style="color:#66d9ef">)</span>/success -H <span style="color:#e6db74">&#34;Host: sample.app&#34;</span> -H <span style="color:#e6db74">&#34;X-Canary: always&#34;</span>
</code></pre></div><p>After firing some requests and waiting about a minute for Prometheus to scrape the metrics and the <strong>AnalysisRun</strong> to measure the <code>success-share</code> metric, you should see one of the measurements with a value of <code>[1]</code>, meaning that the Success Share has been successfully measured at 100%! üíØ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">‚ûú kubectl describe analysisrun -n sample-app
...
Status:
  Metric Results:
    Count:  <span style="color:#ae81ff">5</span>
    Measurements:
      ...
      Finished At:  2022-01-29T18:41:49Z
      Phase:        Successful
      Started At:   2022-01-29T18:41:49Z
      Value:        <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>
    Name:           success-share
    Phase:          Running
    Successful:     <span style="color:#ae81ff">5</span>
  Phase:            Running
  Started At:       2022-01-29T18:37:49Z
Events:             &lt;none&gt;
</code></pre></div><p>The best part of this is, that while all of this was happening, the Rollout kept on progressing and has probably already reached the next step: increasing the <code>canary-weight</code> to 75%.</p>
<p><img src="/images/smart-canary-deployment/4.png" alt="Argo Rollouts Dashboard"></p>
<p>That‚Äôs great! But let‚Äôs make things more interesting: what happens once the Success Share falls below 99%? üò±</p>
<p>Let‚Äôs go ahead and simulate a 50% Success Share by sending several requests and alternating between successes and errors!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl <span style="color:#66d9ef">$(</span>minikube ip<span style="color:#66d9ef">)</span>/success -H <span style="color:#e6db74">&#34;Host: sample.app&#34;</span> -H <span style="color:#e6db74">&#34;X-Canary: always&#34;</span>
curl <span style="color:#66d9ef">$(</span>minikube ip<span style="color:#66d9ef">)</span>/error -H <span style="color:#e6db74">&#34;Host: sample.app&#34;</span> -H <span style="color:#e6db74">&#34;X-Canary: always&#34;</span>
</code></pre></div><p>After a short while, you should notice that something quite magical has happened‚Ä¶ ü™Ñ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">‚ûú kubectl describe analysisrun -n sample-app
...
Status:
  Message:  metric <span style="color:#e6db74">&#34;success-share&#34;</span> assessed Failed due to failed <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span> &gt; failureLimit <span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>
  Metric Results:
    Count:   <span style="color:#ae81ff">9</span>
    Failed:  <span style="color:#ae81ff">1</span>
    Measurements:
      ...
      Finished At:  2022-01-29T18:45:49Z
      Phase:        Failed
      Started At:   2022-01-29T18:45:49Z
      Value:        <span style="color:#f92672">[</span>0.5<span style="color:#f92672">]</span>
    Name:           success-share
    Phase:          Failed
    Successful:     <span style="color:#ae81ff">8</span>
  Phase:            Failed
  Started At:       2022-01-29T18:37:49Z
Events:
  Type     Reason             Age   From                 Message
  ----     ------             ----  ----                 -------
  Warning  MetricFailed       17s   rollouts-controller  metric <span style="color:#e6db74">&#39;success-share&#39;</span> completed Failed
  Warning  AnalysisRunFailed  17s   rollouts-controller  analysis completed Failed
</code></pre></div><p>As soon as the <strong>AnalysisRun</strong> recorded a measurement breaching below the 99% Success Share threshold, the Rollout was immediately aborted.</p>
<p>Let‚Äôs confirm that from the Rollout‚Äôs status real quick!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">‚ûú kubectl argo rollouts status sample-app -n sample-app
Degraded
Error: The rollout is in a degraded state with message: RolloutAborted: Rollout aborted update to revision 2: metric <span style="color:#e6db74">&#34;success-share&#34;</span> assessed Failed due to failed <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span> &gt; failureLimit <span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>
</code></pre></div><p>Indeed, even the Dashboard highlights that the Rollout is in a <em>Degraded</em> state, and consequently the <code>canary-weight</code> has been taken down to 0%.</p>
<p><img src="/images/smart-canary-deployment/5.png" alt="Argo Rollouts Dashboard"></p>
<p>This would, in practice, give us time to investigate the issue, and once fixed, <strong>retry</strong> the Rollout, either via the CLI or the Dashboard‚Äôs <em>RETRY</em> button.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl argo rollouts retry rollout sample-app -n sample-app
kubectl argo rollouts promote sample-app -n sample-app
</code></pre></div><p>Now that the Rollout has restarted and reached step 2, a new <strong>AnalysisRun</strong> has started and the incremental rollout is back on track! üõ§</p>
<p><img src="/images/smart-canary-deployment/6.png" alt="Argo Rollouts Dashboard"></p>
<h3 id="load-testing-with-k6">Load Testing with k6</h3>
<hr>
<p>Instead of running some <code>curl</code> commands like we previously did, how about we execute a Load Test instead?</p>
<p>For Load Testing, I really recommend <a href="https://k6.io/docs/">k6</a> from the Grafana Labs team. It is a dead-simple yet super powerful tool with very extensive documentation.</p>
<p>See for yourself!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cd ..
env URL<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>minikube ip<span style="color:#66d9ef">)</span> k6 run k6/script.js
</code></pre></div><p>After about 1 minute, k6 should be done executing the load test and show you the results.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">          /<span style="color:#ae81ff">\ </span>     |‚Äæ‚Äæ| /‚Äæ‚Äæ/   /‚Äæ‚Äæ/
     /<span style="color:#ae81ff">\ </span> /  <span style="color:#ae81ff">\ </span>    |  |/  /   /  /
    /  <span style="color:#ae81ff">\/</span>    <span style="color:#ae81ff">\ </span>   |     <span style="color:#f92672">(</span>   /   ‚Äæ‚Äæ<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   /          <span style="color:#ae81ff">\ </span>  |  |<span style="color:#ae81ff">\ </span> <span style="color:#ae81ff">\ </span>|  <span style="color:#f92672">(</span>‚Äæ<span style="color:#f92672">)</span>  |
  / __________ <span style="color:#ae81ff">\ </span> |__| <span style="color:#ae81ff">\_</span>_<span style="color:#ae81ff">\ \_</span>____/ .io

  execution: local
     script: k6/script.js
     output: -

  scenarios: <span style="color:#f92672">(</span>100.00%<span style="color:#f92672">)</span> <span style="color:#ae81ff">1</span> scenario, <span style="color:#ae81ff">20</span> max VUs, 1m30s max duration <span style="color:#f92672">(</span>incl. graceful stop<span style="color:#f92672">)</span>:
           * default: Up to <span style="color:#ae81ff">20</span> looping VUs <span style="color:#66d9ef">for</span> 1m0s over <span style="color:#ae81ff">3</span> stages <span style="color:#f92672">(</span>gracefulRampDown: 30s, gracefulStop: 30s<span style="color:#f92672">)</span>

running <span style="color:#f92672">(</span>1m00.2s<span style="color:#f92672">)</span>, 00/20 VUs, <span style="color:#ae81ff">819</span> complete and <span style="color:#ae81ff">0</span> interrupted iterations
default ‚úì <span style="color:#f92672">[======================================]</span> 00/20 VUs  1m0s

     ‚úì status code is <span style="color:#ae81ff">200</span>
     ‚úì node is minikube
     ‚úì namespace is sample-app
     ‚úì pod is sample-app-*
     ‚úì deployment is stable or canary

   ‚úì checks.........................: 100.00% ‚úì <span style="color:#ae81ff">4095</span>      ‚úó <span style="color:#ae81ff">0</span>
     data_received..................: <span style="color:#ae81ff">201</span> kB  3.3 kB/s
     data_sent......................: <span style="color:#ae81ff">94</span> kB   1.6 kB/s
     http_req_blocked...............: avg<span style="color:#f92672">=</span>19.08¬µs min<span style="color:#f92672">=</span>3¬µs   med<span style="color:#f92672">=</span>5¬µs    max<span style="color:#f92672">=</span>982¬µs   p<span style="color:#f92672">(</span>90<span style="color:#f92672">)=</span>7¬µs    p<span style="color:#f92672">(</span>95<span style="color:#f92672">)=</span>8¬µs
     http_req_connecting............: avg<span style="color:#f92672">=</span>12.19¬µs min<span style="color:#f92672">=</span>0s    med<span style="color:#f92672">=</span>0s     max<span style="color:#f92672">=</span>885¬µs   p<span style="color:#f92672">(</span>90<span style="color:#f92672">)=</span>0s     p<span style="color:#f92672">(</span>95<span style="color:#f92672">)=</span>0s
   ‚úì http_req_duration..............: avg<span style="color:#f92672">=</span>1.52ms  min<span style="color:#f92672">=</span>701¬µs med<span style="color:#f92672">=</span>1.24ms max<span style="color:#f92672">=</span>38.97ms p<span style="color:#f92672">(</span>90<span style="color:#f92672">)=</span>1.89ms p<span style="color:#f92672">(</span>95<span style="color:#f92672">)=</span>2.26ms
       <span style="color:#f92672">{</span> expected_response:true <span style="color:#f92672">}</span>...: avg<span style="color:#f92672">=</span>1.52ms  min<span style="color:#f92672">=</span>701¬µs med<span style="color:#f92672">=</span>1.24ms max<span style="color:#f92672">=</span>38.97ms p<span style="color:#f92672">(</span>90<span style="color:#f92672">)=</span>1.89ms p<span style="color:#f92672">(</span>95<span style="color:#f92672">)=</span>2.26ms
     http_req_failed................: 0.00%   ‚úì <span style="color:#ae81ff">0</span>         ‚úó <span style="color:#ae81ff">819</span>
     http_req_rate..................: 50.00%  ‚úì <span style="color:#ae81ff">819</span>       ‚úó <span style="color:#ae81ff">819</span>
     ‚úì <span style="color:#f92672">{</span> deployment:canary <span style="color:#f92672">}</span>........: 48.22%  ‚úì <span style="color:#ae81ff">395</span>       ‚úó <span style="color:#ae81ff">424</span>
     ‚úì <span style="color:#f92672">{</span> deployment:stable <span style="color:#f92672">}</span>........: 51.77%  ‚úì <span style="color:#ae81ff">424</span>       ‚úó <span style="color:#ae81ff">395</span>
     http_req_receiving.............: avg<span style="color:#f92672">=</span>51.59¬µs min<span style="color:#f92672">=</span>29¬µs  med<span style="color:#f92672">=</span>47¬µs   max<span style="color:#f92672">=</span>163¬µs   p<span style="color:#f92672">(</span>90<span style="color:#f92672">)=</span>69.2¬µs p<span style="color:#f92672">(</span>95<span style="color:#f92672">)=</span>84.09¬µs
     http_req_sending...............: avg<span style="color:#f92672">=</span>23.85¬µs min<span style="color:#f92672">=</span>12¬µs  med<span style="color:#f92672">=</span>21¬µs   max<span style="color:#f92672">=</span>106¬µs   p<span style="color:#f92672">(</span>90<span style="color:#f92672">)=</span>34¬µs   p<span style="color:#f92672">(</span>95<span style="color:#f92672">)=</span>37¬µs
     http_req_tls_handshaking.......: avg<span style="color:#f92672">=</span>0s      min<span style="color:#f92672">=</span>0s    med<span style="color:#f92672">=</span>0s     max<span style="color:#f92672">=</span>0s      p<span style="color:#f92672">(</span>90<span style="color:#f92672">)=</span>0s     p<span style="color:#f92672">(</span>95<span style="color:#f92672">)=</span>0s
     http_req_waiting...............: avg<span style="color:#f92672">=</span>1.44ms  min<span style="color:#f92672">=</span>646¬µs med<span style="color:#f92672">=</span>1.16ms max<span style="color:#f92672">=</span>38.91ms p<span style="color:#f92672">(</span>90<span style="color:#f92672">)=</span>1.8ms  p<span style="color:#f92672">(</span>95<span style="color:#f92672">)=</span>2.17ms
     http_reqs......................: <span style="color:#ae81ff">819</span>     13.613372/s
     iteration_duration.............: avg<span style="color:#f92672">=</span>1s      min<span style="color:#f92672">=</span>1s    med<span style="color:#f92672">=</span>1s     max<span style="color:#f92672">=</span>1.03s   p<span style="color:#f92672">(</span>90<span style="color:#f92672">)=</span>1s     p<span style="color:#f92672">(</span>95<span style="color:#f92672">)=</span>1s
     iterations.....................: <span style="color:#ae81ff">819</span>     13.613372/s
     vus............................: <span style="color:#ae81ff">1</span>       min<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>       max<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>
     vus_max........................: <span style="color:#ae81ff">20</span>      min<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>      max<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>
</code></pre></div><p>That sounds about right!<br>
Depending on which step the Rollout is at, the Traffic Distribution shown in k6‚Äôs output should be either 50/50 or 75/25.</p>
<p>Same as before, if you now describe the <strong>AnalysisRun</strong>, you should see some successful measurements were measured.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">‚ûú kubectl describe analysisrun -n sample-app
...
Status:
  Metric Results:
    Count:  <span style="color:#ae81ff">5</span>
    Measurements:
      ...
      Phase:        Successful
      Started At:   2022-01-30T14:34:07Z
      Value:        <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>
    Name:           success-share
    Phase:          Running
    Successful:     <span style="color:#ae81ff">5</span>
  Phase:            Running
  Started At:       2022-01-30T14:32:07Z
Events:             &lt;none&gt;
</code></pre></div><p>Eventually, the Rollout should complete successfully and the new revision should become the new <code>stable</code> Deployment! üéâ</p>
<p><img src="/images/smart-canary-deployment/7.png" alt="Argo Rollouts Dashboard"></p>
<h2 id="wrapping-up">Wrapping up</h2>
<hr>
<p>That‚Äôs it! You can now stop and delete your Minikube cluster!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">minikube stop <span style="color:#f92672">&amp;&amp;</span> minikube delete
</code></pre></div><p>To summarize, using Argo Rollouts and Prometheus we were able to:</p>
<ul>
<li>Detect when a Prometheus metric breaches a given threshold and abort the faulty Rollout automatically, thanks to the <strong>AnalysisRun</strong> CRD;</li>
<li>Restart the aborted Rollout effortlessly once the issue is fixed.</li>
</ul>
<p>Was it worth it? Did that help you understand how to implement Canary Deployment in Kubernetes using Argo Rollouts and Prometheus?</p>
<p>If so, follow me on <a href="https://twitter.com/jhandguy">Twitter</a>, I‚Äôll be happy to answer any of your questions and you‚Äôll be the first one to know when a new article comes out! üëå</p>
<p>Bye-bye! üëã</p>

        </div>
    </div>
    <div class="container is-fullhd has-text-centered mt-6">
        <div class="columns is-mobile">
            <div class="column">
                
                <a class="button is-primary is-pulled-left" href="https://jhandguy.github.io/posts/automated-canary-deployment/"><strong>Previous</strong></a>
                
            </div>
            <div class="column">
                <a class="button is-dark" href="#top"><strong>Back to top</strong></a>
            </div>
            <div class="column">
                
                <a class="button is-primary is-pulled-right" disabled><strong>Next</strong></a>
                
            </div>
        </div>
    </div>
</section>
</body>
<footer>
    <div class="footer has-background-light">
        <div class="content has-text-centered">
            <p class="subtitle is-6">Powered by <a class="has-text-primary" href="https://gohugo.io/">Hugo</a></p>
            <a href="https://bulma.io">
                <img src="https://bulma.io/images/made-with-bulma.png" alt="Made with Bulma" width="128" height="24">
            </a>
        </div>
    </div>
</footer>
</html>