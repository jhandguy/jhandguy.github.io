<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Horizontal Pod Autoscaler in Kubernetes (Part 2) — Advanced Autoscaling using Prometheus Adapter</title>
    <link rel="stylesheet" href="/css/bulma.min.css">
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="stylesheet" href="/css/hugo.css">
</head>

<body>
<nav class="navbar">
    <div class="navbar-brand">
        <a class="navbar-item" href="/">
            Home
        </a>

        <div class="navbar-item">
            <a class="button is-link" href="/about">
                <strong>About me</strong>
            </a>
        </div>
    </div>
</nav>

<section class="section">
    <div class="container is-max-desktop">
        <div class="content">
            <p class="title is-spaced">Horizontal Pod Autoscaler in Kubernetes (Part 2) — Advanced Autoscaling using Prometheus Adapter</p>
            
            
            <div class="box">
                <p class="subtitle">Table of Contents</p>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#creating-kind-cluster">Creating Kind Cluster</a></li>
    <li><a href="#installing-nginx-ingress-controller">Installing NGINX Ingress Controller</a></li>
    <li><a href="#installing-prometheus">Installing Prometheus</a></li>
    <li><a href="#installing-prometheus-adapter">Installing Prometheus Adapter</a></li>
    <li><a href="#autoscaling-services-based-on-prometheus-metrics">Autoscaling Services based on Prometheus Metrics</a></li>
    <li><a href="#wrapping-up">Wrapping up</a></li>
  </ul>
</nav>
            </div>
            
            
        </div>
    </div>
    <div class="container is-max-desktop mt-6">
        <div class="content has-text-justified-tablet">
            <p>The Horizontal Pod Autoscaler (HPA) is a fundamental feature of Kubernetes. It enables automatic scale-up and scale-down of containerized applications based on CPU usage, memory usage, or custom metrics.</p>
<p>Traditionally, when scaling software, we first think of vertical scaling: the CPU and the RAM are increased so the application consuming them can perform better. While this seems like a flawless mechanism on paper, it actually comes with many drawbacks.</p>
<p>First, upgrading the CPU or RAM on a physical machine (or VM) requires downtime and unless a Pod Disruption Budget (PDB) is used to handle <a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions">disruptions</a>, all pods will be evicted and recreated in the new resized node.</p>
<p>Nodes resource usage is also not optimized, as scaling vertically means requiring sufficient resources in a single node, while horizontal scaling may have the same amount of resources distributed across multiple nodes.</p>
<p>Additionally, vertical scaling is not as resilient as horizontal scaling, as fewer replicas mean higher risks of disruptions in case of node failure.</p>
<p>Finally, reaching a certain threshold, scaling only vertically becomes very expensive and most importantly, isn’t limitless. In fact, there is only so much CPU and RAM a physical machine(or VM) alone can handle.<br>
This is where horizontal scaling comes into play!</p>
<blockquote>
<p>Eventually, it is more efficient to duplicate an instance, than increase its resources.</p>
</blockquote>
<p>🎬 Hi there, I&rsquo;m Jean!</p>
<p>In this 2 parts series, we&rsquo;re going to explore several ways to scale services horizontally in Kubernetes, and the second one is…<br>
🥁<br>
… using <strong>Prometheus Adapter</strong>! 🎊</p>
<h2 id="requirements">Requirements</h2>
<hr>
<p>Before we start, make sure you have the following tools installed:</p>
<ul>
<li><a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation">Kind</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/">Kubectl</a></li>
<li><a href="https://helm.sh/docs/intro/install/">Helm</a></li>
<li><a href="https://k6.io/docs/getting-started/installation/">K6</a></li>
</ul>
<blockquote>
<p><em>Note: for MacOS users or Linux users using Homebrew, simply run:</em><br>
<code>brew install kind kubectl helm k6</code></p>
</blockquote>
<p>All set? Let’s go! 🏁</p>
<h2 id="creating-kind-cluster">Creating Kind Cluster</h2>
<hr>
<p><a href="https://kind.sigs.k8s.io/">Kind</a> is a tool for running local Kubernetes clusters using Docker container “nodes”.
It was primarily designed for testing Kubernetes itself, but may be used for local development or CI.</p>
<p>I don’t expect you to have a demo project in handy, so <a href="https://github.com/jhandguy/canary-deployment">I built one</a> for you.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git clone https://github.com/jhandguy/horizontal-pod-autoscaler.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> horizontal-pod-autoscaler
</span></span></code></pre></div><p>Alright, let&rsquo;s spin up our Kind cluster! 🚀</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ kind create cluster --image kindest/node:v1.27.3 --config<span class="o">=</span>kind/cluster.yaml
</span></span><span class="line"><span class="cl">Creating cluster <span class="s2">&#34;kind&#34;</span> ...
</span></span><span class="line"><span class="cl"> ✓ Ensuring node image <span class="o">(</span>kindest/node:v1.27.3<span class="o">)</span> 🖼
</span></span><span class="line"><span class="cl"> ✓ Preparing nodes 📦
</span></span><span class="line"><span class="cl"> ✓ Writing configuration 📜
</span></span><span class="line"><span class="cl"> ✓ Starting control-plane 🕹️
</span></span><span class="line"><span class="cl"> ✓ Installing CNI 🔌
</span></span><span class="line"><span class="cl"> ✓ Installing StorageClass 💾
</span></span><span class="line"><span class="cl">Set kubectl context to <span class="s2">&#34;kind-kind&#34;</span>
</span></span><span class="line"><span class="cl">You can now use your cluster with:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl cluster-info --context kind-kind
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community 🙂
</span></span></code></pre></div><h2 id="installing-nginx-ingress-controller">Installing NGINX Ingress Controller</h2>
<hr>
<p><a href="https://github.com/kubernetes/ingress-nginx">NGINX Ingress Controller</a> is one of the <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/#additional-controllers">many available Kubernetes Ingress Controllers</a>, which acts as a load balancer and satisfies routing rules specified in <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#what-is-ingress">Ingress</a> resources, using the <a href="https://nginx.org/en/">NGINX reverse proxy</a>.</p>
<p>NGINX Ingress Controller can be installed via its <a href="https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx">Helm chart</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
</span></span><span class="line"><span class="cl">helm install ingress-nginx/ingress-nginx --name-template ingress-nginx --create-namespace -n ingress-nginx --values kind/ingress-nginx-values.yaml --version 4.8.3 --wait
</span></span></code></pre></div><p>Now, if everything goes according to plan, you should be able to see the <strong>ingress-nginx-controller</strong> Deployment running.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ kubectl get deploy -n ingress-nginx
</span></span><span class="line"><span class="cl">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">ingress-nginx-controller   1/1     <span class="m">1</span>            <span class="m">1</span>           4m35s
</span></span></code></pre></div><h2 id="installing-prometheus">Installing Prometheus</h2>
<hr>
<p>Prometheus can be installed via its community <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack">Helm chart</a>, which also provides <a href="https://grafana.com/grafana/">Grafana</a> out of the box.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span class="line"><span class="cl">helm install prometheus-community/kube-prometheus-stack --name-template prometheus --create-namespace -n prometheus --version 54.2.2 --wait
</span></span></code></pre></div><p>If everything went fine, you should be able to see three newly spawned deployments with the READY state!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ kubectl get deploy -n prometheus
</span></span><span class="line"><span class="cl">NAME                                  READY   UP-TO-DATE   AVAILABLE   
</span></span><span class="line"><span class="cl">prometheus-grafana                    1/1     <span class="m">1</span>            <span class="m">1</span>           
</span></span><span class="line"><span class="cl">prometheus-kube-prometheus-operator   1/1     <span class="m">1</span>            <span class="m">1</span>           
</span></span><span class="line"><span class="cl">prometheus-kube-state-metrics         1/1     <span class="m">1</span>            <span class="m">1</span>
</span></span></code></pre></div><h2 id="installing-prometheus-adapter">Installing Prometheus Adapter</h2>
<hr>
<p><a href="https://github.com/kubernetes-sigs/prometheus-adapter">Prometheus Adapter</a> is a source of custom metrics, which collects them from Prometheus and exposes them in Kubernetes API server through <a href="https://github.com/kubernetes/metrics">Metrics API</a> for use by <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">Horizontal Pod Autoscaler</a> and <a href="https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler/">Vertical Pod Autoscaler</a>.</p>
<p>Unlike <a href="https://github.com/kubernetes-sigs/metrics-server">Metrics Server</a> which is limited to resource metrics, Prometheus Adapter exposes custom metrics measurable from within a Pod&rsquo;s container, such as memory usage, GC duration, but also request throughput, latency, etc.</p>
<blockquote>
<p><em>If you haven&rsquo;t already, go read <a href="/posts/simple-horizontal-autoscaling/">Horizontal Pod Autoscaler in Kubernetes (Part 1) - Simple Autoscaling using Metrics Server</a> and learn how to implement a Horizontal Pod Autoscaler using Metrics Server!</em></p>
</blockquote>
<p>Prometheus Adapter can be installed via its <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus-adapter">Helm chart</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm install prometheus-community/prometheus-adapter --name-template prometheus-adapter --create-namespace -n prometheus-adapter --values kind/prometheus-adapter-values.yaml --version 4.9.0 --wait
</span></span></code></pre></div><p>Now, if all goes well, you should see the <strong>prometheus-adapter</strong> Deployment running with the READY state.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ kubectl get deploy -n prometheus-adapter
</span></span><span class="line"><span class="cl">NAME                 READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">prometheus-adapter   1/1     <span class="m">1</span>            <span class="m">1</span>           52s
</span></span></code></pre></div><h2 id="autoscaling-services-based-on-prometheus-metrics">Autoscaling Services based on Prometheus Metrics</h2>
<hr>
<p>Now that Prometheus Adapter is up and running, let&rsquo;s get to it, shall we? 🧐</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">helm install golang-sample-app/helm-chart --name-template sample-app --create-namespace -n sample-app --set prometheus.enabled<span class="o">=</span><span class="nb">true</span> --wait
</span></span></code></pre></div><p>If everything goes fine, you should eventually see one Deployment with the READY state.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ kubectl get deploy -n sample-app
</span></span><span class="line"><span class="cl">NAME         READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">sample-app   2/2     <span class="m">2</span>            <span class="m">2</span>           28s
</span></span></code></pre></div><p>Alright, now let&rsquo;s have a look at the HPA!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜ kubectl describe hpa -n sample-app
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Metrics: <span class="o">(</span> current / target <span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;golang_sample_app_requests_per_second&#34;</span> on pods:  &lt;unknown&gt; / <span class="m">10</span>
</span></span><span class="line"><span class="cl">Min replicas:                                       <span class="m">2</span>
</span></span><span class="line"><span class="cl">Max replicas:                                       <span class="m">8</span>
</span></span></code></pre></div><p>As you can see, this HPA is configured to scale the service based on requests per second (rps), with an average of <strong>10</strong>.</p>
<blockquote>
<p><em>Note: as you probably have noticed, the current value for the request throughput is <strong>unknown</strong>, this is expected as the service hasn&rsquo;t served any requests yet, thus no timeseries for this metric are present in Prometheus.</em></p>
</blockquote>
<p>This means that as soon as the request throughput breaches the <strong>10rps</strong> threshold, the HPA will trigger an upscale.</p>
<p>Under minimal load, the HPA will still retain a replica count of <strong>2</strong>, while the maximum amount of Pods the HPA is allowed to spin up under high load is <strong>8</strong>.</p>
<blockquote>
<p><em>Note: in a production environment, it is recommended to have a minimum replica count of at least 3, to guarantee maintained availability in the case of <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/_print/#pod-disruption">Pod Disruption</a>.</em></p>
</blockquote>
<p>Now, this is the moment you&rsquo;ve certainly expected… It&rsquo;s Load Testing time! 😎</p>
<p>For Load Testing, I really recommend <a href="https://k6.io/docs/">k6</a> from the Grafana Labs team. It is a dead-simple yet super powerful tool with very extensive documentation.</p>
<p>See for yourself!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">k6 run k6/script.js
</span></span></code></pre></div><p>While the load test is running, I suggest watching the HPA in a separate tab.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl get hpa -n sample-app -w
</span></span></code></pre></div><p>As the load test progresses and the 2 starting Pods start to handle more than 10rps each, you should see the Prometheus metric&rsquo;s target increasing, and ultimately, the <strong>replica count reaching its maximum</strong>!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Deployment/sample-app   &lt;unknown&gt;/10   <span class="m">2</span>         <span class="m">8</span>         <span class="m">2</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   4360m/10       <span class="m">2</span>         <span class="m">8</span>         <span class="m">2</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   6236m/10       <span class="m">2</span>         <span class="m">8</span>         <span class="m">2</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   12471m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">2</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   15577m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">3</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   21231m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">3</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   21231m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">5</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   16752m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">5</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   18362m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">5</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   15921m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">6</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   15543m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">6</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   16530m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">8</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   15397m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">8</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   14428m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">8</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   11897m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">8</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   12370m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">8</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   12423m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">8</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   12414m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">8</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   12423m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">8</span>
</span></span><span class="line"><span class="cl">Deployment/sample-app   10962m/10      <span class="m">2</span>         <span class="m">8</span>         <span class="m">8</span>
</span></span></code></pre></div><p>Now, let&rsquo;s quickly have a look at the Load Test summary and the result of the <code>http_req_duration</code> metric in particular!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">          /<span class="se">\ </span>     <span class="p">|</span>‾‾<span class="p">|</span> /‾‾/   /‾‾/
</span></span><span class="line"><span class="cl">     /<span class="se">\ </span> /  <span class="se">\ </span>    <span class="p">|</span>  <span class="p">|</span>/  /   /  /
</span></span><span class="line"><span class="cl">    /  <span class="se">\/</span>    <span class="se">\ </span>   <span class="p">|</span>     <span class="o">(</span>   /   ‾‾<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   /          <span class="se">\ </span>  <span class="p">|</span>  <span class="p">|</span><span class="se">\ </span> <span class="se">\ </span><span class="p">|</span>  <span class="o">(</span>‾<span class="o">)</span>  <span class="p">|</span>
</span></span><span class="line"><span class="cl">  / __________ <span class="se">\ </span> <span class="p">|</span>__<span class="p">|</span> <span class="se">\_</span>_<span class="se">\ \_</span>____/ .io
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  execution: <span class="nb">local</span>
</span></span><span class="line"><span class="cl">     script: k6/script.js
</span></span><span class="line"><span class="cl">     output: -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  scenarios: <span class="o">(</span>100.00%<span class="o">)</span> <span class="m">1</span> scenario, <span class="m">100</span> max VUs, 5m30s max duration <span class="o">(</span>incl. graceful stop<span class="o">)</span>:
</span></span><span class="line"><span class="cl">           * load: Up to 100.00 iterations/s <span class="k">for</span> 5m0s over <span class="m">2</span> stages <span class="o">(</span>maxVUs: 100, gracefulStop: 30s<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     ✓ status code is <span class="m">200</span>
</span></span><span class="line"><span class="cl">     ✓ node is kind-control-plane
</span></span><span class="line"><span class="cl">     ✓ namespace is sample-app
</span></span><span class="line"><span class="cl">     ✓ pod is sample-app-*
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   ✓ checks.........................: 100.00% ✓ <span class="m">60356</span>     ✗ <span class="m">0</span>
</span></span><span class="line"><span class="cl">     data_received..................: 3.5 MB  <span class="m">12</span> kB/s
</span></span><span class="line"><span class="cl">     data_sent......................: 1.7 MB  5.8 kB/s
</span></span><span class="line"><span class="cl">     http_req_blocked...............: <span class="nv">avg</span><span class="o">=</span>18.43µs <span class="nv">min</span><span class="o">=</span>1µs     <span class="nv">med</span><span class="o">=</span>8µs    <span class="nv">max</span><span class="o">=</span>3.9ms  p<span class="o">(</span>90<span class="o">)=</span>17µs    p<span class="o">(</span>95<span class="o">)=</span>20µs
</span></span><span class="line"><span class="cl">     http_req_connecting............: <span class="nv">avg</span><span class="o">=</span>5.41µs  <span class="nv">min</span><span class="o">=</span>0s      <span class="nv">med</span><span class="o">=</span>0s     <span class="nv">max</span><span class="o">=</span>3.7ms  p<span class="o">(</span>90<span class="o">)=</span>0s      p<span class="o">(</span>95<span class="o">)=</span>0s
</span></span><span class="line"><span class="cl">   ✓ http_req_duration..............: <span class="nv">avg</span><span class="o">=</span>16.74ms <span class="nv">min</span><span class="o">=</span>498µs   <span class="nv">med</span><span class="o">=</span>2.77ms <span class="nv">max</span><span class="o">=</span>1.48s  p<span class="o">(</span>90<span class="o">)=</span>14.52ms p<span class="o">(</span>95<span class="o">)=</span>64.78ms
</span></span><span class="line"><span class="cl">       <span class="o">{</span> expected_response:true <span class="o">}</span>...: <span class="nv">avg</span><span class="o">=</span>16.74ms <span class="nv">min</span><span class="o">=</span>498µs   <span class="nv">med</span><span class="o">=</span>2.77ms <span class="nv">max</span><span class="o">=</span>1.48s  p<span class="o">(</span>90<span class="o">)=</span>14.52ms p<span class="o">(</span>95<span class="o">)=</span>64.78ms
</span></span><span class="line"><span class="cl">     http_req_failed................: 0.00%   ✓ <span class="m">0</span>         ✗ <span class="m">15089</span>
</span></span><span class="line"><span class="cl">     http_req_receiving.............: <span class="nv">avg</span><span class="o">=</span>97.15µs <span class="nv">min</span><span class="o">=</span>9µs     <span class="nv">med</span><span class="o">=</span>74µs   <span class="nv">max</span><span class="o">=</span>3.33ms p<span class="o">(</span>90<span class="o">)=</span>151µs   p<span class="o">(</span>95<span class="o">)=</span>197µs
</span></span><span class="line"><span class="cl">     http_req_sending...............: <span class="nv">avg</span><span class="o">=</span>48.11µs <span class="nv">min</span><span class="o">=</span>6µs     <span class="nv">med</span><span class="o">=</span>34µs   <span class="nv">max</span><span class="o">=</span>3.12ms p<span class="o">(</span>90<span class="o">)=</span>69µs    p<span class="o">(</span>95<span class="o">)=</span>86µs
</span></span><span class="line"><span class="cl">     http_req_tls_handshaking.......: <span class="nv">avg</span><span class="o">=</span>0s      <span class="nv">min</span><span class="o">=</span>0s      <span class="nv">med</span><span class="o">=</span>0s     <span class="nv">max</span><span class="o">=</span>0s     p<span class="o">(</span>90<span class="o">)=</span>0s      p<span class="o">(</span>95<span class="o">)=</span>0s
</span></span><span class="line"><span class="cl">     http_req_waiting...............: <span class="nv">avg</span><span class="o">=</span>16.59ms <span class="nv">min</span><span class="o">=</span>452µs   <span class="nv">med</span><span class="o">=</span>2.61ms <span class="nv">max</span><span class="o">=</span>1.48s  p<span class="o">(</span>90<span class="o">)=</span>14.32ms p<span class="o">(</span>95<span class="o">)=</span>64.69ms
</span></span><span class="line"><span class="cl">     http_reqs......................: <span class="m">15089</span>   50.297179/s
</span></span><span class="line"><span class="cl">     iteration_duration.............: <span class="nv">avg</span><span class="o">=</span>17.18ms <span class="nv">min</span><span class="o">=</span>610.5µs <span class="nv">med</span><span class="o">=</span>3.21ms <span class="nv">max</span><span class="o">=</span>1.48s  p<span class="o">(</span>90<span class="o">)=</span>15.08ms p<span class="o">(</span>95<span class="o">)=</span>65.33ms
</span></span><span class="line"><span class="cl">     iterations.....................: <span class="m">15089</span>   50.297179/s
</span></span><span class="line"><span class="cl">     vus............................: <span class="m">0</span>       <span class="nv">min</span><span class="o">=</span><span class="m">0</span>       <span class="nv">max</span><span class="o">=</span><span class="m">18</span>
</span></span><span class="line"><span class="cl">     vus_max........................: <span class="m">100</span>     <span class="nv">min</span><span class="o">=</span><span class="m">100</span>     <span class="nv">max</span><span class="o">=</span><span class="m">100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">running <span class="o">(</span>5m00.0s<span class="o">)</span>, 000/100 VUs, <span class="m">15089</span> <span class="nb">complete</span> and <span class="m">0</span> interrupted iterations
</span></span><span class="line"><span class="cl">load ✓ <span class="o">[======================================]</span> 000/100 VUs  5m0s  000.65 iters/s
</span></span></code></pre></div><p>As you can observe, our service has performed very well under heavy load, with a Success Share of 100%, a median latency of ~3ms, and a 95th percentile latency of ~50ms!</p>
<p>We have the HPA to thank for that, as it scaled the Deployment from 2 to 8 Pods swiftly and automatically, based on request throughput!</p>
<p>We definitely would not have had the same results without an HPA… Actually, why don&rsquo;t you try it yourself? 😉</p>
<p>Just delete the HPA (<code>kubectl delete hpa sample-app -n sample-app</code>), run the load test again (<code>k6 run k6/script.js</code>) and see what happens! (spoiler alert: it&rsquo;s not pretty 😬)</p>
<h2 id="wrapping-up">Wrapping up</h2>
<hr>
<p>That&rsquo;s it! You can now stop and delete your Kind cluster.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kind delete cluster
</span></span></code></pre></div><p>To summarize, using Prometheus Adapter we were able to:</p>
<ul>
<li>Autoscale horizontally our service, based on Prometheus metrics.</li>
</ul>
<p>Was it worth it? Did that help you understand how to implement Horizontal Pod Autoscaler in Kubernetes using Prometheus Adapter?</p>
<p>If so, follow me on <a href="https://twitter.com/jhandguy">Twitter</a>, I’ll be happy to answer any of your questions and you’ll be the first one to know when a new article comes out! 👌</p>
<p>Bye-bye! 👋</p>

        </div>
    </div>
</section>

</body>
<footer>
    <div class="footer pt-3 has-background-black-bis">
        <div class="container pb-6 has-text-centered is-mobile columns">
            <div class="column is-narrow paddingless">
                
                
                <a class="button is-large" href="https://jhandguy.github.io/posts/simple-horizontal-autoscaling/"><strong>👈</strong></a>
                
                
            </div>
            <div class="column"></div>
            <div class="column is-narrow paddingless">
                <a class="button is-large" href="#"><strong>👆</strong></a>
            </div>
            <div class="column"></div>
            <div class="column is-narrow paddingless">
                
                
                <a class="button is-large" href="https://jhandguy.github.io/posts/vertical-pod-autoscaler/"><strong>👉</strong></a>
                
                
            </div>
        </div>
        <div class="content has-text-centered">
            <p class="subtitle is-6">Powered by <a href="https://gohugo.io/">Hugo</a></p>
            <a href="https://bulma.io">
                <img src="/images/footer/made-with-bulma.png" alt="Made with Bulma" width="128" height="24">
            </a>
        </div>
    </div>
</footer>

</html>
